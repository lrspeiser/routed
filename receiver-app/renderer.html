<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Routed Receiver</title>
  <style>
    :root {
      --bg: #fffdfa;           /* soft white */
      --panel: #f4efe7;        /* light warm panel */
      --border: #e2d8c8;       /* subtle warm border */
      --brown: #3d2b1f;        /* primary brown */
      --green: #7fbf3f;        /* accent green */
      --green-ink: #2a5d1a;    /* darker green for text */
    }
    * { box-sizing: border-box; }
    body { font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial; margin: 16px; background: var(--bg); color: var(--brown); }
    a { color: var(--green-ink); }
    header { display:flex; align-items:center; gap:8px; }
    header img { width: 18px; height: 18px; }
    .ver { font-size: 12px; opacity: .6; margin-left: 6px; }
    input, button, select { font-size: 14px; padding: 8px; margin: 4px 0; }
    input, select { width: 100%; border: 1px solid var(--border); border-radius: 8px; background: #fff; color: var(--brown); }
    button { background: var(--green); color: #fff; border: none; border-radius: 8px; cursor: pointer; width: auto; }
    button:hover { filter: brightness(0.95); }
    button#tabClient, button#tabDev, button#tabSettings { background: transparent; color: var(--brown); border: 1px solid var(--border); }
    #log { white-space: pre-wrap; height: 240px; overflow: auto; background: #fbf7ef; color: var(--green-ink); padding: 8px; border-radius: 8px; border: 1px solid var(--border); }
    .row { margin-top: 8px; }
    #toast { position: fixed; top: 20px; right: 20px; background: var(--brown); color:#fff; padding:12px 14px; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,0.15); display:none; max-width: 320px; }
    #toast .t-title { font-weight:600; margin-bottom:4px; }
  </style>
</head>
<body>
  <header>
    <img src="routed_icon.png" alt="Routed" />
    <h2 style="margin:0; display:flex; align-items:center; gap:6px; flex:1">Routed <span id="appVer" class="ver"></span></h2>
    <button id="quitBtn" style="font-size:12px; padding:4px 8px">Quit</button>
  </header>
  <div class="row" style="opacity:.7">Before connecting, we’ll check your server health.</div>
  <div class="row" id="health">Checking server…</div>

  <div id="regOverlay" style="position:fixed; inset:0; background:rgba(255,253,250,0.98); display:none; padding:16px; z-index:9999; overflow:auto">
    <h3>Register your phone</h3>
    <div id="regStepPhone">
      <div class="row" style="display:flex; gap:8px; align-items:center">
        <select id="country" style="width:160px">
          <option value="US" selected>United States (+1)</option>
          <option value="CA">Canada (+1)</option>
          <option value="GB">United Kingdom (+44)</option>
          <option value="AU">Australia (+61)</option>
        </select>
        <input id="phoneInput" placeholder="+14155551234" style="flex:1" />
      </div>
      <button id="sendCodeBtn">Send Code</button>
      <div id="regError" style="color:#b91c1c; margin-top:6px"></div>
    </div>
    <div id="regStepCode" style="display:none">
      <div class="row">
        <label>Enter the code we texted you</label>
        <input id="codeInput" placeholder="123456" />
      </div>
      <button id="verifyCodeBtn">Verify</button>
      <div id="regError2" style="color:#b91c1c; margin-top:6px"></div>
      <div class="row" style="font-size:12px; opacity:.7">Didn’t get it? Wait a moment and try again.</div>
    </div>
  </div>

  <div class="row" style="margin-top:16px">
    <div style="display:flex; gap:8px; border-bottom:1px solid var(--border); padding-bottom:6px">
      <button id="tabClient" style="flex:1">Client</button>
      <button id="tabDev" style="flex:1">Developer</button>
      <button id="tabScripts" style="flex:1">Scripts</button>
      <button id="tabSettings" title="Settings" style="width:42px">⚙︎</button>
    </div>
  </div>
  <div id="toast"><div class="t-title"></div><div class="t-body"></div></div>

  <div id="clientTab" class="row">
    <h3>Notifications</h3>
    <div id="status"></div>
    <div id="notifList" style="margin-top:8px; display:flex; flex-direction:column; gap:8px"></div>
    <div class="row">
      <h4 style="margin:12px 0 4px">Log</h4>
      <div style="display:flex; gap:8px; align-items:center; margin-bottom:6px">
        <button id="clearMainLogBtn">Clear</button>
        <button id="copyMainLogBtn">Copy</button>
      </div>
      <pre id="log" style="height:160px; overflow:auto; background:#0b0b0b; color:#9be37f; padding:8px; border-radius:8px"></pre>
    </div>
  </div>

  <div id="devTab" class="row" style="display:none">
    <h3>Developer</h3>
    <div id="devInfo" style="background:var(--panel); padding:8px; border-radius:8px; border:1px solid var(--border); display:flex; gap:8px; align-items:center; justify-content:space-between">
      <div>
        <div style="font-size:12px; opacity:.7">Developer ID</div>
        <div id="devId" style="font-family:monospace">Not created</div>
      </div>
    </div>

    <div class="row">
      <label>New Channel</label>
      <div style="display:flex; gap:8px">
        <input id="newChannelName" placeholder="e.g., QA Team" />
        <button id="createChannelBtn">Create</button>
      </div>
    </div>

    <div class="row">
      <label>Channel</label>
      <select id="channelSelect"></select>
    </div>

    <div class="row" id="usersSection" style="display:none">
      <h4 style="margin:8px 0 4px">Team Members</h4>
      <ul id="usersList" style="margin:0; padding-left:18px"></ul>
      <div style="display:flex; gap:8px; margin-top:6px; align-items:center">
        <select id="addCountry" style="width:160px">
          <option value="US" selected>United States (+1)</option>
          <option value="CA">Canada (+1)</option>
          <option value="GB">United Kingdom (+44)</option>
          <option value="AU">Australia (+61)</option>
        </select>
        <input id="addPhones" placeholder="+14155551234" />
        <button id="addUsersBtn">Add</button>
      </div>
    </div>

    <div class="row">
      <label>Message</label>
      <input id="messageText" placeholder="Type your message" />
      <label style="margin-top:8px">Link (optional)</label>
      <input id="linkUrl" placeholder="https://www.google.com" value="https://www.google.com" />
      <button id="sendBtn">Send to Channel</button>
      <div style="margin-top:8px; font-size:13px">
        <a href="#" id="toggleCurl">Show curl</a>
        <div id="curlPanel" style="display:none; margin-top:6px">
      <pre id="curlCmd" style="white-space:pre-wrap; background:#fbf7ef; color:var(--green-ink); padding:8px; border-radius:8px; border:1px solid var(--border)"></pre>
          <button id="copyCurlBtn">Copy curl</button>
        </div>
      </div>
    </div>
    <div class="row">
      <h4 style="margin:8px 0 4px">Logs</h4>
      <div style="display:flex; gap:8px; align-items:center; margin-bottom:6px">
        <button id="clearLogsBtn">Clear</button>
        <button id="copyLogsBtn">Copy</button>
      </div>
      <pre id="devlog" style="height:200px; overflow:auto; background:#fbf7ef; color:var(--green-ink); padding:8px; border-radius:8px; border:1px solid var(--border)"></pre>
    </div>
  </div>


  <div id="scriptsTab" class="row" style="display:none">
    <h3>Scripts</h3>
    <div class="row" style="display:flex; gap:8px; align-items:center">
      <input id="newScriptName" placeholder="Name (e.g., RSS Poller)" />
      <select id="newScriptMode" style="width:160px">
        <option value="poller" selected>Auto-run</option>
        <option value="webhook">Webhook</option>
      </select>
      <button id="createScriptBtn">Create</button>
    </div>
    <div class="row">
      <h4 style="margin:8px 0 4px">Your scripts</h4>
      <ul id="scriptsList" style="margin:0; padding-left:18px"></ul>
    </div>
    <div id="scriptEdit" style="display:none; margin-top:12px">
      <h4 id="scriptTitle" style="margin:8px 0 4px"></h4>
      <div id="scriptMeta" style="font-size:12px; opacity:.7; margin-bottom:6px"></div>
      <div id="scriptActions" style="display:flex; gap:8px; align-items:center; margin:6px 0">
        <label style="display:flex; gap:6px; align-items:center">
          <input type="checkbox" id="scriptEnabled" /> Enabled
        </label>
        <button id="scriptRunNowBtn">Run Now</button>
        <span id="webhookUrlView" style="font-size:12px; opacity:.8"></span>
        <button id="copyWebhookUrlBtn" title="Copy Webhook URL">Copy URL</button>
        <button id="copyWebhookCurlBtn" title="Copy cURL">Copy cURL</button>
        <button id="sendWebhookTestBtn" title="POST test JSON">Send Test</button>
      </div>
      <textarea id="scriptCode" style="width:100%; height:220px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', monospace"></textarea>
      <div style="display:flex; gap:8px; margin-top:8px; align-items:center; flex-wrap: wrap">
        <button id="showLogsBtn">Show Logs</button>
        <button id="clearScriptLogsBtn">Clear Logs</button>
        <button id="saveScriptBtn">Save</button>
        <button id="testScriptBtn">Test</button>
        <button id="runNowScriptBtn">Run Now</button>
      </div>
      <div id="scriptOutput" style="margin-top:8px; background:#fbf7ef; color:var(--green-ink); padding:8px; border-radius:8px; border:1px solid var(--border); white-space:pre-wrap"></div>
      <div style="display:flex; gap:8px; margin-top:6px">
        <button id="saveAndTestBtn">Save + Test</button>
        <button id="copyOutputBtn">Copy Output</button>
      </div>
    </div>
  </div>

  <div id="settingsTab" class="row" style="display:none">
    <h3>Settings</h3>
    <div class="row" style="background:var(--panel); padding:10px; border-radius:8px; border:1px solid var(--border)">
      <div style="display:flex; gap:8px; align-items:center; justify-content:space-between">
        <div style="flex:1">
          <div style="font-size:12px; opacity:.7">Server</div>
          <div id="serverView" style="word-break:break-all"></div>
        </div>
        <div>
          <button id="editServerBtn">Edit</button>
        </div>
      </div>
      <div id="serverEdit" style="display:none; margin-top:8px; display:flex; gap:8px; align-items:center">
        <input id="serverUrl" placeholder="https://your.server" style="flex:1" />
        <button id="saveServerBtn">Save</button>
        <button id="cancelServerBtn">Cancel</button>
      </div>
    </div>

    <div class="row" style="background:var(--panel); padding:10px; border-radius:8px; border:1px solid var(--border)">
      <div style="display:flex; gap:8px; align-items:center; justify-content:space-between">
        <div style="flex:1">
          <div style="font-size:12px; opacity:.7">Phone</div>
          <div id="settingsPhoneView"></div>
        </div>
        <div>
          <button id="editPhoneBtn">Edit</button>
          <button id="connectNowBtn">Connect</button>
          <button id="logoutBtn">Logout</button>
      </div>
      <div id="phoneEdit" style="display:none; margin-top:8px; display:flex; gap:8px; align-items:center">
        <select id="settingsCountry" style="width:160px">
          <option value="US" selected>United States (+1)</option>
          <option value="CA">Canada (+1)</option>
          <option value="GB">United Kingdom (+44)</option>
          <option value="AU">Australia (+61)</option>
        </select>
        <input id="settingsPhone" placeholder="+14155551234" style="flex:1" />
        <button id="savePhoneBtn">Save</button>
        <button id="cancelPhoneBtn">Cancel</button>
      </div>
    </div>

    <div class="row" style="background:var(--panel); padding:10px; border-radius:8px; border:1px solid var(--border)">
      <div style="display:flex; gap:8px; align-items:center; justify-content:space-between">
        <div style="flex:1">
          <div style="font-size:12px; opacity:.7">Developer Key</div>
          <div id="devKeyView" style="font-family:monospace; word-break:break-all">Not created</div>
        </div>
        <div style="display:flex; gap:8px">
          <button id="copyDevKeyBtn">Copy</button>
          <button id="editDevKeyBtn">Edit</button>
          <button id="provisionBtn">Generate</button>
        </div>
      </div>
      <div id="devKeyEdit" style="display:none; margin-top:8px; display:flex; gap:8px; align-items:center">
        <input id="devKeyInput" placeholder="Paste API key" style="flex:1; font-family:monospace" />
        <button id="saveDevKeyBtn">Save</button>
        <button id="cancelDevKeyBtn">Cancel</button>
      </div>
    </div>

    <div class="row" style="font-size:12px; opacity:.7">Default: https://routed.onrender.com</div>
  </div>

  <script>
    const logEl = document.getElementById('log');
    function log(msg) { logEl.textContent += '\n' + new Date().toISOString() + ' ' + msg; logEl.scrollTop = logEl.scrollHeight; }

    // Configurable server base URL (persisted via main process)
    let BASE_URL = 'https://routed.onrender.com';
    const healthEl = document.getElementById('health');

    function fetchTimeout(resource, options = {}, timeoutMs = 3000) {
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeoutMs);
      return fetch(resource, { ...options, signal: controller.signal })
        .finally(() => clearTimeout(id));
    }

    async function checkHealth() {
      try {
        // Fast-path deep health with 2s timeout
        let url = new URL('/v1/health/deep', BASE_URL).toString();
        devlog(`[health] GET ${url}`);
        let res = await fetchTimeout(url, { cache: 'no-store' }, 2000);
        const status1 = res.status;
        const text1 = await res.text().catch(() => '');
        devlog(`[health] deep status=${status1} body=${text1}`);
        let ok1 = false;
        try { const j = JSON.parse(text1); ok1 = !!(j && j.ok); } catch {}
        if (status1 === 200 && ok1) {
          healthEl.innerHTML = `Server: <span style="color:#22c55e">OK</span>`;
          return true;
        }
        // Fallback: simple /healthz with 2s timeout
        url = new URL('/healthz', BASE_URL).toString();
        devlog(`[health] GET ${url}`);
        res = await fetchTimeout(url, { cache: 'no-store' }, 2000);
        const status2 = res.status;
        const text2 = await res.text().catch(() => '');
        devlog(`[health] healthz status=${status2} body=${text2}`);
        let ok2 = false;
        try { const j2 = JSON.parse(text2); ok2 = !!(j2 && j2.ok); } catch {}
        if (status2 === 200 && ok2) {
          healthEl.innerHTML = `Server: <span style="color:#22c55e">OK</span>`;
          return true;
        }
        healthEl.textContent = `Health check failed. Status ${status2}`;
        return false;
      } catch (e) {
        const msg = (e && (e.name === 'AbortError' ? 'timeout' : e.message)) || String(e);
        healthEl.textContent = `Health check error: ${msg}`;
        devlog(`[health] error: ${msg}`);
        return false;
      }
    }

    async function preflightOrFail() {
      const ok = await checkHealth();
      if (!ok) {
        showToast('Cannot connect', 'Server is unreachable. Check Settings → Server and try again.');
        return false;
      }
      return true;
    }
    let ws;
    const recentMsgs = [];
    function isDuplicateMessage(data) {
      try {
        const key = `${data.title||''}|${data.body||''}`;
        const now = Date.now();
        // purge old
        while (recentMsgs.length && now - recentMsgs[0].t > 5000) recentMsgs.shift();
        if (recentMsgs.some(x => x.k === key)) return true;
        recentMsgs.push({ k: key, t: now });
        return false;
      } catch { return false; }
    }
    const notifList = document.getElementById('notifList');
    const devlogEl = document.getElementById('devlog');
    function devlog(msg) {
      const line = `${new Date().toISOString()} ${msg}`;
      // Mirror to visible Log section
      try { log(msg); } catch {}
      // Developer log panel
      if (devlogEl) {
        devlogEl.textContent += (devlogEl.textContent ? '\n' : '') + line;
        devlogEl.scrollTop = devlogEl.scrollHeight;
      }
      try { window.receiver.debugLog(line); } catch {}
    }
    function addNotificationCard(data) {
      const card = document.createElement('div');
      card.style.border = '1px solid #ddd';
      card.style.borderRadius = '8px';
      card.style.padding = '8px';
      card.innerHTML = `\u003cdiv style=\"font-weight:600\"\u003e${(data.title||'').replace(/\u003c/g,'\u0026lt;')}\u003c/div\u003e\u003cdiv\u003e${(data.body||'').replace(/\u003c/g,'\u0026lt;')}\u003c/div\u003e`;
      notifList.prepend(card);
      try { devlog('Client: received notification'); } catch {}
    }
    function showToast(title, body) {
      const el = document.getElementById('toast');
      el.querySelector('.t-title').textContent = title || 'Notification';
      el.querySelector('.t-body').textContent = body || '';
      el.style.display = 'block';
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => { el.style.display = 'none'; }, 3500);
    }
    function makeWsUrl(base, userId, path) {
      const url = new URL(base);
      const wsProto = url.protocol === 'https:' ? 'wss' : 'ws';
      return `${wsProto}://${url.host}${path}?user_id=${encodeURIComponent(userId)}`;
    }

    async function connectWithPhone(phone) {
      try {
        // Provision tenant if needed and ensure phone user on hub
        let d = await window.receiver.devGet();
        if (!d || !d.apiKey) { devlog('dev:provision (pre-connect)'); await window.receiver.devProvision(); d = await window.receiver.devGet(); }
        if (!d || !d.apiKey) { devlog('dev:provision failed'); return; }
        const ensured = await window.receiver.adminUsersEnsure({ phone, topic: 'runs.finished' });
        if (!ensured || !ensured.userId) { devlog('users:ensure failed'); return; }
        const userId = ensured.userId;
        devlog(`Resolved: base_url=${BASE_URL} user_id=${userId}`);
        const base = BASE_URL;
        const urlV1 = makeWsUrl(base, userId, '/v1/socket');
        const urlAlt = makeWsUrl(base, userId, '/socket');

        async function tryConnect(urls) {
          if (!urls.length) { log('All WS endpoints failed'); return; }
          const next = urls[0];
          devlog(`WS connecting: ${next}`);
          return new Promise((resolve) => {
            let opened = false;
            const candidate = new WebSocket(next);
            candidate.onopen = () => {
              opened = true;
              ws = candidate;
              devlog('Client: WS open');
              document.getElementById('status').textContent = 'Connected';
              resolve(null);
            };
            candidate.onmessage = (ev) => {
              devlog(`Client: WS message ${ev.data}`);
              try {
                const data = JSON.parse(ev.data);
                if (data && data.type === 'hello') {
                  // handshake ok
                } else if (data && data.title) {
                  if (!isDuplicateMessage(data)) {
                    window.receiver.showNotification(data);
                    addNotificationCard(data);
                  } else {
                    devlog('Client: duplicate message suppressed');
                  }
                }
              } catch {}
            };
            candidate.onclose = (e) => {
              if (!opened) {
                devlog(`WS close before open (${next}) code=${e.code}`);
                tryConnect(urls.slice(1)).then(resolve);
              } else {
                devlog(`Client: WS closed code=${e.code} reason=${e.reason}`);
                document.getElementById('status').textContent = 'Disconnected';
              }
            };
            candidate.onerror = (e) => {
              try { devlog(`Client: WS error on ${next}: ` + (e.message || JSON.stringify(e))); } catch { devlog('Client: WS error'); }
            };
          });
        }

        await tryConnect([urlAlt, urlV1]);
        devlog('autoconnect ok for phone ' + phone);
      } catch (e) {
        devlog('Connect failed: ' + (e && e.message ? e.message : e));
      }
    }


    // Tabs
    const clientTab = document.getElementById('clientTab');
    const devTab = document.getElementById('devTab');
    const scriptsTab = document.getElementById('scriptsTab');
    const settingsTab = document.getElementById('settingsTab');
    function showTab(which) {
      clientTab.style.display = which === 'client' ? '' : 'none';
      devTab.style.display = which === 'dev' ? '' : 'none';
      scriptsTab.style.display = which === 'scripts' ? '' : 'none';
      settingsTab.style.display = which === 'settings' ? '' : 'none';
    }
    document.getElementById('tabClient').addEventListener('click', () => showTab('client'));
    document.getElementById('tabDev').addEventListener('click', () => showTab('dev'));
    document.getElementById('tabScripts').addEventListener('click', () => showTab('scripts'));
    document.getElementById('tabSettings').addEventListener('click', () => showTab('settings'));

    // Scripts tab logic (scaffold)\n    // AI generate scaffolding\n    const aiPanel = document.createElement('div');\n    aiPanel.style.marginTop = '8px';\n    aiPanel.innerHTML = `\n      <div style="margin-top:8px; border-top:1px solid var(--border); padding-top:8px">\n        <h4 style="margin:8px 0 4px">Rewrite with AI</h4>\n        <div style="display:flex; gap:8px; align-items:flex-start">\n          <textarea id="aiPrompt" placeholder="Describe what the script should do (e.g., poll https://api.example.com and notify when X)" style="flex:1; height:80px"></textarea>\n          <button id="aiGenerateBtn">Generate</button>\n        </div>\n      </div>\n    `;\n    document.getElementById('scriptEdit').appendChild(aiPanel);\n    document.getElementById('aiGenerateBtn').addEventListener('click', async () => {\n      try {\n        const id = window.__currentScriptId; if (!id) return;\n        const s = await window.scripts.get(id); if (!s) return;\n        const prompt = (document.getElementById('aiPrompt').value||'').trim();\n        if (!prompt) { alert('Enter a prompt'); return; }\n        const resp = await window.scripts.aiGenerate({ mode: s.mode, prompt, currentCode: s.__code, topic: (s.manifest && s.manifest.defaultTopic) || 'runs.finished' });\n        if (resp && resp.ok && resp.code) {\n          document.getElementById('scriptCode').value = resp.code;\n          await window.scripts.update(id, { code: resp.code, manifest: (resp.manifestDelta||{}) });\n          showToast('AI generated code applied','');\n        } else {\n          showToast('AI generate failed', (resp && resp.error) || '');\n        }\n      } catch (e) { devlog('ai generate failed ' + String(e)); }\n    });

    // Scripts tab logic (scaffold)
    const scriptsListEl = document.getElementById('scriptsList');
    async function refreshScriptsList() {
      try {
        const items = await window.scripts.list();
        scriptsListEl.innerHTML = '';
        (items || []).forEach(s => {
          const li = document.createElement('li');
          const a = document.createElement('a'); a.href = '#'; a.textContent = `${s.name} (${s.mode})`;
          a.addEventListener('click', async () => openScriptEditor(s.id));
          li.appendChild(a); scriptsListEl.appendChild(li);
        });
      } catch (e) { devlog('scripts:list failed ' + String(e)); }
    }
    async function openScriptEditor(id) {
      try {
        const s = await window.scripts.get(id);
        if (!s) { devlog('script not found'); return; }
        window.__currentScriptId = s.id;
        document.getElementById('scriptTitle').textContent = s.name || s.id;
        document.getElementById('scriptMeta').textContent = `Mode: ${s.mode}`;
        document.getElementById('scriptCode').value = (s.__code || '');
        const enabledEl = document.getElementById('scriptEnabled'); enabledEl.checked = !!s.enabled;
        const urlEl = document.getElementById('webhookUrlView');
        if (s.mode === 'webhook') {
          const u = await window.scripts.webhookUrl(s.id);
          urlEl.textContent = u ? `Webhook: ${u}` : '';
        } else { urlEl.textContent = ''; }
        document.getElementById('scriptEdit').style.display = '';
      } catch (e) { devlog('open editor failed ' + String(e)); }
    }
    document.getElementById('createScriptBtn').addEventListener('click', async () => {
      const name = (document.getElementById('newScriptName').value||'').trim();
      const mode = (document.getElementById('newScriptMode').value||'poller');
      if (!name) { alert('Enter a script name'); return; }
      const r = await window.scripts.create({ name, mode });
      document.getElementById('newScriptName').value = '';
      await refreshScriptsList();
      try { await openScriptEditor(r.id); } catch {}
    });
    // Save + Test handlers
    document.getElementById('saveScriptBtn').addEventListener('click', async () => {
      try {
        const id = window.__currentScriptId; if (!id) return;
        const code = document.getElementById('scriptCode').value;
        await window.scripts.update(id, { code });
        showToast('Saved','');
      } catch (e) { devlog('save failed ' + String(e)); }
    });
    document.getElementById('testScriptBtn').addEventListener('click', async () => {
      try {
        const id = window.__currentScriptId; if (!id) return;
        const outEl = document.getElementById('scriptOutput'); outEl.textContent = 'Running test...';
        const res = await window.scripts.test(id);
        outEl.textContent = (res && res.ok ? '[ok]\n' : '[error]\n') + (res?.stdout || '') + (res?.stderr || '');
      } catch (e) { devlog('test failed ' + String(e)); }
    });
    document.getElementById('saveAndTestBtn').addEventListener('click', async () => {
      try { const id = window.__currentScriptId; if (!id) return; await window.scripts.update(id, { code: document.getElementById('scriptCode').value }); const res = await window.scripts.test(id); const outEl = document.getElementById('scriptOutput'); outEl.textContent = (res && res.ok ? '[ok]\n' : '[error]\n') + (res?.stdout || '') + (res?.stderr || ''); } catch (e) { devlog('save+test failed ' + String(e)); }
    });
    document.getElementById('copyOutputBtn').addEventListener('click', async () => { try { await navigator.clipboard.writeText(document.getElementById('scriptOutput').textContent || ''); showToast('Copied output',''); } catch {} });

    // Enable toggle and run now
    document.getElementById('scriptEnabled').addEventListener('change', async (e) => {
      try {
        const id = window.__currentScriptId; if (!id) return;
        const enabled = e.target.checked;
        const res = await window.scripts.enableToggle(id, enabled);
        const urlEl = document.getElementById('webhookUrlView');
        if (enabled) {
          const u = await window.scripts.webhookUrl(id);
          if (u) urlEl.textContent = `Webhook: ${u}`;
        } else { urlEl.textContent = ''; }
        showToast(enabled ? 'Enabled' : 'Disabled','');
        await refreshScriptsList();
      } catch (err) { devlog('enable toggle failed ' + String(err)); }
    });
    document.getElementById('scriptRunNowBtn').addEventListener('click', async () => {
      try { const id = window.__currentScriptId; if (!id) return; const res = await window.scripts.runNow(id); const outEl = document.getElementById('scriptOutput'); outEl.textContent = (res && res.ok ? '[ok]\n' : '[error]\n') + (res?.stdout || '') + (res?.stderr || ''); } catch (e) { devlog('run now failed ' + String(e)); }
    });

    // Logs handlers
    document.getElementById('showLogsBtn').addEventListener('click', async () => {
      try {
        const id = window.__currentScriptId; if (!id) return;
        const r = await window.scripts.logsRead(id);
        const outEl = document.getElementById('scriptOutput');
        if (r && r.ok) { outEl.textContent = r.logs || ''; }
      } catch (e) { devlog('logs read failed ' + String(e)); }
    });
    document.getElementById('clearScriptLogsBtn').addEventListener('click', async () => {
      try { const id = window.__currentScriptId; if (!id) return; await window.scripts.logsClear(id); showToast('Cleared logs',''); } catch (e) { devlog('logs clear failed ' + String(e)); }
    });

    // Webhook test helpers
    document.getElementById('copyWebhookUrlBtn').addEventListener('click', async () => {
      try { const id = window.__currentScriptId; if (!id) return; const u = await window.scripts.webhookUrl(id); if (u) await navigator.clipboard.writeText(u); showToast('Copied URL',''); } catch {}
    });
    document.getElementById('copyWebhookCurlBtn').addEventListener('click', async () => {
      try { const id = window.__currentScriptId; if (!id) return; const u = await window.scripts.webhookUrl(id); if (!u) return; const cmd = `curl -s -X POST -H 'content-type: application/json' -d '{"ok":true,"time":"${new Date().toISOString()}"}' ${u}`; await navigator.clipboard.writeText(cmd); showToast('Copied cURL',''); } catch {}
    });
    document.getElementById('sendWebhookTestBtn').addEventListener('click', async () => {
      try { const id = window.__currentScriptId; if (!id) return; const u = await window.scripts.webhookUrl(id); if (!u) return; const res = await fetch(u, { method: 'POST', headers: { 'content-type':'application/json' }, body: JSON.stringify({ ok: true, time: new Date().toISOString() }) }); const txt = await res.text().catch(()=> ''); const outEl = document.getElementById('scriptOutput'); outEl.textContent = `[${res.status}]\n` + txt; } catch (e) { devlog('webhook test failed ' + String(e)); }
    });

    // Initial load
    refreshScriptsList();

    // Dev console handlers
    const devIdEl = document.getElementById('devId');
    const channelSelect = document.getElementById('channelSelect');
    async function loadChannels() {
      const d = await window.receiver.devGet();
      if (!d || !d.tenantId) return;
      const ch = await window.receiver.adminChannelsList(d.tenantId);
      channelSelect.innerHTML = '';
      ch.forEach((c) => {
        const opt = document.createElement('option');
        opt.value = JSON.stringify({ topic: c.topic, short_id: c.short_id });
        opt.textContent = `${c.name} (${c.short_id})`;
        channelSelect.appendChild(opt);
      });
    }
    async function refreshDevInfo() {
      const d = await window.receiver.devGet();
      devIdEl.textContent = d ? (d.tenantId || 'Unknown') : 'Not created';
      await loadChannels();
    }
    document.getElementById('provisionBtn').addEventListener('click', async () => {
      await window.receiver.devProvision();
      await refreshDevInfo();
    });
    document.getElementById('createChannelBtn').addEventListener('click', async () => {
      const d = await window.receiver.devGet();
      if (!d || !d.tenantId) { alert('Generate Developer ID first'); return; }
      const name = (document.getElementById('newChannelName').value || '').trim();
      if (!name) { alert('Enter a channel name'); return; }
      await window.receiver.adminChannelsCreate({ tenantId: d.tenantId, name, topic: 'runs.finished' });
      document.getElementById('newChannelName').value = '';
      await loadChannels();
    });
    document.getElementById('addUsersBtn').addEventListener('click', async () => {
      const d = await window.receiver.devGet();
      if (!d || !d.tenantId) { alert('Generate Developer ID first'); return; }
      const selected = channelSelect.value ? JSON.parse(channelSelect.value) : null;
      if (!selected) { alert('Choose a channel'); return; }
      const raw = (document.getElementById('addPhones').value || '').trim();
      if (!raw) { alert('Enter phone numbers'); return; }
      const phones = raw.split(/[\n,\s]+/).map((p) => p.trim()).filter(Boolean);
      const country = (document.getElementById('addCountry')?.value || 'US').toUpperCase();
      for (let p of phones) {
        const phone = normalizePhone(country, p);
        await window.receiver.adminUsersEnsure({ tenantId: d.tenantId, phone, topic: selected.topic });
      }
      document.getElementById('addPhones').value = '';
      alert('Added');
    });
    let sending = false;
    document.getElementById('sendBtn').addEventListener('click', async () => {
      if (sending) { return; }
      const selected = channelSelect.value ? JSON.parse(channelSelect.value) : null;
      if (!selected) { alert('Choose a channel'); return; }
      const text = (document.getElementById('messageText').value || '').trim();
      if (!text) { alert('Enter a message'); return; }
      sending = true;
      const btn = document.getElementById('sendBtn');
      const prev = btn.disabled; btn.disabled = true;
      try { devlog(`Client: sending message topic=${selected.topic} body=${text}`); } catch {}
      const link = (document.getElementById('linkUrl').value || '').trim();
      const payload = link ? { url: link.startsWith('http') ? link : 'https://' + link } : null;
      const res = await window.receiver.devSendMessage({ topic: selected.topic, title: 'Routed', body: text, payload });
      try { devlog(`Client: send result ${res ? 'ok' : 'error'}`); } catch {}
      document.getElementById('messageText').value = '';
      btn.disabled = prev; sending = false;
    });

    async function ensureDevChannelForPhone(phone) {
      try {
        let d = await window.receiver.devGet();
        if (!d) {
          await window.receiver.devProvision();
          d = await window.receiver.devGet();
        }
        if (!d || !d.tenantId) return;
        let ch = await window.receiver.adminChannelsList(d.tenantId);
        if (!Array.isArray(ch) || ch.length === 0) {
          await window.receiver.adminChannelsCreate({ tenantId: d.tenantId, name: 'Default', topic: 'runs.finished' });
          ch = await window.receiver.adminChannelsList(d.tenantId);
        }
        if (Array.isArray(ch) && ch.length > 0) {
          const first = ch[0];
          channelSelect.innerHTML = '';
          const opt = document.createElement('option');
          opt.value = JSON.stringify({ topic: first.topic });
          opt.textContent = `${first.name} (${first.short_id})`;
          channelSelect.appendChild(opt);
          // Do NOT re-ensure here to avoid duplicate subscriptions; connectWithPhone already ensured
        }
      } catch {}
    }

    // Phone helpers (global)
    function dialCodeFor(country) {
      switch ((country||'US').toUpperCase()) {
        case 'US': return '1';
        case 'CA': return '1';
        case 'GB': return '44';
        case 'AU': return '61';
        default: return '1';
      }
    }
    function normalizePhone(country, input) {
      const raw = String(input || '').trim();
      if (!raw) return '';
      if (raw.startsWith('+')) {
        const rest = raw.slice(1).replace(/[^0-9]/g, '');
        return '+' + rest;
      }
      const digits = raw.replace(/[^0-9]/g, '');
      const dial = dialCodeFor(country);
      return '+' + dial + digits;
    }

    function updateCurl() {
      (async () => {
        try {
          const d = await window.receiver.devGet();
          const apiKey = d && d.apiKey ? d.apiKey : '$API_KEY';
          let topic = 'runs.finished';
          try {
            const selected = channelSelect.value ? JSON.parse(channelSelect.value) : null;
            if (selected && selected.topic) topic = selected.topic;
          } catch {}
          const endpoint = new URL('/v1/messages', BASE_URL).toString();
          const cmd = [
            'curl -X POST',
            "-H 'Authorization: Bearer " + apiKey + "'",
            "-H 'Content-Type: application/json'",
            "-d '{" +
              "\"topic\": \"" + topic + "\", " +
              "\"title\": \"Routed\", " +
              "\"body\": \"Hello from CLI\", " +
              "\"payload\": {\"url\": \"" + ((document.getElementById('linkUrl')?.value || 'https://www.google.com').replace(/"/g,'\\"')) + "\"}}'",
            endpoint
          ].join(' ');
          document.getElementById('curlCmd').textContent = cmd;
        } catch {}
      })();
    }

    (async () => {
      // Load server URL
      try {
        BASE_URL = await window.receiver.devGetBaseUrl() || BASE_URL;
        const su = document.getElementById('serverUrl');
        const sv = document.getElementById('serverView');
        if (su) su.value = BASE_URL;
        if (sv) sv.textContent = BASE_URL;
      } catch {}
      // Set version label
      try {
        const v = await window.receiver.appVersion();
        const el = document.getElementById('appVer');
        if (el && v) el.textContent = `v${v}`;
      } catch {}

      const healthy = await checkHealth();
      // Registration gate
      let verified = false;
      try { const d = await window.receiver.devGet(); verified = !!(d && d.verifiedUserId && d.verifiedPhone); } catch {}
      const overlay = document.getElementById('regOverlay');
      if (!verified) {
        // Hard reset any stale local data on first run when not verified
        try { await window.receiver.devReset(); } catch {}
        try { localStorage.removeItem('ROUTED_PHONE'); } catch {}
        overlay.style.display = 'block';
        showTab('settings');
      }

      try {
        const saved = localStorage.getItem('ROUTED_PHONE');
        if (verified && saved) {
          try { document.getElementById('settingsPhone').value = saved; } catch {}
          try { document.getElementById('settingsPhoneView').textContent = saved; } catch {}
          if (healthy) {
            await connectWithPhone(saved);
            await ensureDevChannelForPhone(saved);
            showTab('dev');
            try { document.getElementById('messageText')?.focus(); } catch {}
          } else {
            showToast('Cannot connect', 'Server is unreachable. Check Settings → Server and try again.');
            showTab('settings');
          }
        }
        // Debug: log sockets snapshot to help diagnose delivery
        try {
          const snap = await window.receiver.adminSockets();
          await window.receiver.debugLog('sockets snapshot: ' + JSON.stringify(snap));
        } catch {}
      } catch {}
      await refreshDevInfo();
      // Populate dev key view
      try {
        const d = await window.receiver.devGet();
        const k = d && d.apiKey ? d.apiKey : '';
        const vEl = document.getElementById('devKeyView'); if (vEl) vEl.textContent = k || 'Not created';
      } catch {}
    })();
    // Settings: view/edit toggles
    document.getElementById('editServerBtn').addEventListener('click', () => { document.getElementById('serverEdit').style.display='flex'; });
    document.getElementById('cancelServerBtn').addEventListener('click', () => { document.getElementById('serverEdit').style.display='none'; });
    document.getElementById('editPhoneBtn').addEventListener('click', () => { document.getElementById('phoneEdit').style.display='flex'; });
    document.getElementById('cancelPhoneBtn').addEventListener('click', () => { document.getElementById('phoneEdit').style.display='none'; });
    document.getElementById('editDevKeyBtn').addEventListener('click', async () => { document.getElementById('devKeyEdit').style.display='flex'; try { document.getElementById('devKeyInput').value = (await window.receiver.devGet())?.apiKey || ''; } catch {} });
    document.getElementById('cancelDevKeyBtn').addEventListener('click', () => { document.getElementById('devKeyEdit').style.display='none'; });

    document.getElementById('saveServerBtn').addEventListener('click', async () => {
      try {
        const su = document.getElementById('serverUrl');
        const url = (su.value || '').trim();
        if (!url) { alert('Enter server URL'); return; }
        BASE_URL = await window.receiver.devSetBaseUrl(url) || url;
        const sv = document.getElementById('serverView'); if (sv) sv.textContent = BASE_URL;
        devlog('Saved server: ' + BASE_URL);
        document.getElementById('serverEdit').style.display='none';
        await checkHealth();
      } catch {}
    });
    document.getElementById('clearLogsBtn').addEventListener('click', () => { if (devlogEl) devlogEl.textContent=''; });
    document.getElementById('clearMainLogBtn').addEventListener('click', () => { if (logEl) logEl.textContent=''; });
    document.getElementById('copyMainLogBtn').addEventListener('click', async () => {
      try { await navigator.clipboard.writeText(logEl.textContent || ''); showToast('Copied logs',''); } catch {}
    });
    document.getElementById('copyLogsBtn').addEventListener('click', async () => {
      try { await navigator.clipboard.writeText(devlogEl.textContent || ''); showToast('Copied logs',''); } catch {}
    });
    document.getElementById('copyCurlBtn').addEventListener('click', async () => {
      try { await navigator.clipboard.writeText(document.getElementById('curlCmd').textContent || ''); showToast('Copied curl',''); } catch {}
    });
    document.getElementById('toggleCurl').addEventListener('click', (e) => { e.preventDefault(); const p = document.getElementById('curlPanel'); p.style.display = p.style.display === 'none' ? '' : 'none'; if (p.style.display !== 'none') updateCurl(); });
    document.getElementById('quitBtn').addEventListener('click', () => { try { window.receiver.appQuit(); } catch {} });

    // Registration overlay handlers
    (function(){
      const countryEl = document.getElementById('country');
      const phoneEl = document.getElementById('phoneInput');
      const codeEl = document.getElementById('codeInput');
      const stepPhone = document.getElementById('regStepPhone');
      const stepCode = document.getElementById('regStepCode');
      const err1 = document.getElementById('regError');
      const err2 = document.getElementById('regError2');

      document.getElementById('sendCodeBtn').addEventListener('click', async () => {
        err1.textContent='';
        const country = (countryEl.value||'US').toUpperCase();
        const phoneRaw = (phoneEl.value||'').trim();
        if (!phoneRaw) { err1.textContent = 'Enter your phone number'; return; }
        const phone = normalizePhone(country, phoneRaw);
        const ok = await window.receiver.verifyStart({ phone, country });
        if (!ok || ok.ok === false) { err1.textContent = 'Failed to send code. Try again.'; return; }
        stepPhone.style.display='none'; stepCode.style.display='block';
      });

      document.getElementById('verifyCodeBtn').addEventListener('click', async () => {
        err2.textContent='';
        const country = (countryEl.value||'US').toUpperCase();
        const phone = normalizePhone(country, (phoneEl.value||'').trim());
        const code = (codeEl.value||'').trim();
        if (!code) { err2.textContent='Enter the code'; return; }
        const res = await window.receiver.verifyCheck({ phone, code });
        if (!res || res.ok === false) { err2.textContent='Invalid code. Try again.'; return; }
        try { localStorage.setItem('ROUTED_PHONE', phone); } catch {}
        document.getElementById('regOverlay').style.display='none';
        showToast('Verified', 'Your phone is verified.');
        // Optionally auto-connect post verification
        const ok = await preflightOrFail(); if (ok) { await connectWithPhone(phone); await ensureDevChannelForPhone(phone); showTab('dev'); }
      });

      // Settings-level logout button
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        try {
          await window.receiver.devReset();
          localStorage.removeItem('ROUTED_PHONE');
          document.getElementById('settingsPhoneView').textContent = '';
          document.getElementById('settingsPhone').value = '';
          document.getElementById('regOverlay').style.display = 'block';
          showToast('Logged out','');
          showTab('settings');
        } catch {}
      });
    })();

    // Settings handlers for phone/connect
    document.getElementById('savePhoneBtn').addEventListener('click', () => {
      const raw = (document.getElementById('settingsPhone').value || '').trim();
      if (!raw) { alert('Enter your phone'); return; }
      const country = (document.getElementById('settingsCountry')?.value || 'US').toUpperCase();
      const phone = normalizePhone(country, raw);
      try { localStorage.setItem('ROUTED_PHONE', phone); document.getElementById('settingsPhoneView').textContent = phone; document.getElementById('settingsPhone').value = phone; document.getElementById('phoneEdit').style.display='none'; showToast('Saved phone',''); } catch {}
    });
    document.getElementById('connectNowBtn').addEventListener('click', async () => {
      const raw = (document.getElementById('settingsPhone').value || '').trim();
      if (!raw) { alert('Enter your phone'); return; }
      const country = (document.getElementById('settingsCountry')?.value || 'US').toUpperCase();
      const phone = normalizePhone(country, raw);
      // Require verification before allowing connect
      let verified = false; try { const d = await window.receiver.devGet(); verified = !!(d && d.verifiedUserId && d.verifiedPhone); } catch {}
      if (!verified) { showToast('Verification required', 'Please verify your phone number first.'); document.getElementById('regOverlay').style.display='block'; return; }
      const ok = await preflightOrFail(); if (!ok) return;
      try { localStorage.setItem('ROUTED_PHONE', phone); document.getElementById('settingsPhoneView').textContent = phone; document.getElementById('settingsPhone').value = phone; } catch {}
      await connectWithPhone(phone);
      await ensureDevChannelForPhone(phone);
      showTab('dev');
    });

    document.getElementById('copyDevKeyBtn').addEventListener('click', async () => { try { await navigator.clipboard.writeText(document.getElementById('devKeyView').textContent || ''); showToast('Copied key',''); } catch {} });
    document.getElementById('saveDevKeyBtn').addEventListener('click', async () => {
      try {
        const key = (document.getElementById('devKeyInput').value || '').trim();
        await window.receiver.devSetApiKey(key);
        document.getElementById('devKeyView').textContent = key || 'Not created';
        document.getElementById('devKeyEdit').style.display='none';
        showToast('Saved key','');
      } catch {}
    });

    // Load users on channel change
    channelSelect.addEventListener('change', async () => {
      try {
        const selected = channelSelect.value ? JSON.parse(channelSelect.value) : null;
        const sec = document.getElementById('usersSection');
        const list = document.getElementById('usersList');
        if (!selected || !selected.short_id) { sec.style.display = 'none'; list.innerHTML = ''; return; }
        const users = await window.receiver.adminChannelsUsers(selected.short_id);
        list.innerHTML = '';
        for (const u of (users || [])) {
          const li = document.createElement('li');
          li.textContent = u.phone || u.user_id || JSON.stringify(u);
          list.appendChild(li);
        }
        sec.style.display = '';
      } catch {}
    });
  </script>
</body>
</html>
