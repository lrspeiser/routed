<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Notification Receiver</title>
  <style>
    body { font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial; margin: 16px; }
    input, button { font-size: 14px; padding: 8px; margin: 4px 0; width: 100%; }
    #log { white-space: pre-wrap; height: 240px; overflow: auto; background: #111; color: #0f0; padding: 8px; border-radius: 6px; }
    .row { margin-top: 8px; }
  </style>
</head>
<body>
  <h2>Routed Receiver â€¢ Settings</h2>
  <div class="row">
    <label>Subscription ID</label>
    <input id="subId" placeholder="e.g. abc123" />
  </div>
  <div class="row">
    <details>
      <summary>Advanced</summary>
      <label>Resolve Base URL</label>
      <input id="resolveUrl" placeholder="https://playground.example.com" value="https://routed-gbiz.onrender.com" />
    </details>
  </div>
  <button id="addBtn">Add Subscription</button>

  <h3>Subscriptions</h3>
  <div id="subs"></div>

  <h3>Log</h3>
  <div id="log"></div>

  <script>
    const logEl = document.getElementById('log');
    function log(msg) { logEl.textContent += '\n' + new Date().toISOString() + ' ' + msg; logEl.scrollTop = logEl.scrollHeight; }

    const sockets = new Map();
    async function connectOne(sub) {
      try {
        const desc = await window.receiver.resolveChannel(sub.id, sub.resolveUrl);
        if (!desc) return;
        const base = desc.base_url;
        const wsProto = base.startsWith('https') ? 'wss' : 'ws';
        const url = new URL(base);
        const sockUrl = `${wsProto}://${url.host}/v1/socket?user_id=${encodeURIComponent(desc.user_id)}`;
        const ws = new WebSocket(sockUrl);
        sockets.set(sub.id, ws);
        ws.onopen = () => log(`[${sub.id}] WS open`);
        ws.onmessage = (ev) => {
          log(`[${sub.id}] ${ev.data}`);
          try {
            const data = JSON.parse(ev.data);
            if (data && data.title) window.receiver.showNotification(data);
          } catch {}
        };
        ws.onclose = (e) => {
          log(`[${sub.id}] WS closed code=${e.code} reason=${e.reason}`);
          sockets.delete(sub.id);
        };
        ws.onerror = (e) => {
          try { log(`[${sub.id}] WS error: ` + (e.message || JSON.stringify(e))); } catch { log('WS error'); }
        };
      } catch (e) {
        log('Connect failed: ' + e);
      }
    }

    async function refreshSubs() {
      const subs = await window.receiver.listSubscriptions();
      const subsEl = document.getElementById('subs');
      subsEl.innerHTML = '';
      subs.forEach((s) => {
        const row = document.createElement('div');
        row.className = 'row';
        row.textContent = `${s.id}`;
        const del = document.createElement('button');
        del.textContent = 'Delete';
        del.onclick = async () => { await window.receiver.removeSubscription(s.id); await refreshSubs(); };
        const conn = document.createElement('button');
        conn.textContent = 'Connect';
        conn.onclick = () => connectOne(s);
        row.appendChild(del);
        row.appendChild(conn);
        subsEl.appendChild(row);
      });
    }

    document.getElementById('addBtn').addEventListener('click', async () => {
      const id = document.getElementById('subId').value.trim();
      const resolveUrl = document.getElementById('resolveUrl').value.trim();
      if (!id) { alert('Enter Subscription ID'); return; }
      await window.receiver.addSubscription(id, resolveUrl);
      document.getElementById('subId').value = '';
      await refreshSubs();
    });

    refreshSubs();
  </script>
</body>
</html>
