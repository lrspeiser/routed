<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Routed Receiver</title>
  <style>
    body { font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial; margin: 16px; }
    header { display:flex; align-items:center; gap:8px; }
    header img { width: 18px; height: 18px; }
    input, button { font-size: 14px; padding: 8px; margin: 4px 0; width: 100%; }
    #log { white-space: pre-wrap; height: 240px; overflow: auto; background: #111; color: #0f0; padding: 8px; border-radius: 6px; }
    .row { margin-top: 8px; }
  </style>
</head>
<body>
  <header>
    <img src="arrow-icon-routed.png" alt="Routed" />
    <h2 style="margin:0">Routed • Settings</h2>
  </header>
  <div class="row" style="opacity:.7">Before connecting, we check your server health.</div>
  <div class="row" id="health">Checking server…</div>
  <div class="row">
    <label>Your Email</label>
    <input id="email" placeholder="you@example.com" />
  </div>
  <button id="connectBtn" disabled>Connect</button>

  <h3>Status</h3>
  <div id="status">Disconnected</div>

  <h3>Log</h3>
  <div id="log"></div>

  <script>
    const logEl = document.getElementById('log');
    function log(msg) { logEl.textContent += '\n' + new Date().toISOString() + ' ' + msg; logEl.scrollTop = logEl.scrollHeight; }

    const RESOLVE_BASE = 'https://routed-gbiz.onrender.com';
    const healthEl = document.getElementById('health');
    const connectBtn = document.getElementById('connectBtn');

    async function checkHealth() {
      try {
        const res = await fetch(new URL('/api/healthz', RESOLVE_BASE).toString(), { cache: 'no-store' });
        const j = await res.json();
        if (res.ok && j && j.ok) {
          if (j.hub_ok) {
            healthEl.innerHTML = `Server: <span style="color:#22c55e">OK</span> (${j.hub_url || 'not set'})`;
            connectBtn.disabled = false;
          } else {
            healthEl.innerHTML = `Server: <span style="color:#ef4444">UNREACHABLE</span> ${j.hub_error ? '(' + j.hub_error + ')' : ''}. Check HUB_URL on playground/server.`;
            connectBtn.disabled = true;
          }
        } else {
          healthEl.textContent = `Health check failed. Status ${res.status}`;
          connectBtn.disabled = true;
        }
      } catch (e) {
        healthEl.textContent = `Health check error: ${e && e.message ? e.message : e}`;
        connectBtn.disabled = true;
      }
    }
    let ws;
    async function connectWithEmail(email) {
      try {
        const desc = await fetch(new URL('/api/resolve-email', RESOLVE_BASE).toString(), {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email })
        }).then(r=>r.json());
        if (!desc || !desc.base_url || !desc.user_id) { log('Resolve failed'); return; }
        const base = desc.base_url;
        const wsProto = base.startsWith('https') ? 'wss' : 'ws';
        const url = new URL(base);
        const sockUrl = `${wsProto}://${url.host}/v1/socket?user_id=${encodeURIComponent(desc.user_id)}`;
        ws = new WebSocket(sockUrl);
        ws.onopen = () => { log('WS open'); document.getElementById('status').textContent = 'Connected'; };
        ws.onmessage = (ev) => {
          log(ev.data);
          try {
            const data = JSON.parse(ev.data);
            if (data && data.title) window.receiver.showNotification(data);
          } catch {}
        };
        ws.onclose = (e) => {
          log(`WS closed code=${e.code} reason=${e.reason}`);
          document.getElementById('status').textContent = 'Disconnected';
        };
        ws.onerror = (e) => {
          try { log('WS error: ' + (e.message || JSON.stringify(e))); } catch { log('WS error'); }
        };
      } catch (e) {
        log('Connect failed: ' + e);
      }
    }

    document.getElementById('connectBtn').addEventListener('click', async () => {
      const email = document.getElementById('email').value.trim();
      if (!email) { alert('Enter your email'); return; }
      try { localStorage.setItem('ROUTED_EMAIL', email); } catch {}
      await connectWithEmail(email);
    });

    (async () => {
      await checkHealth();
      try {
        const saved = localStorage.getItem('ROUTED_EMAIL');
        if (saved && !connectBtn.disabled) { document.getElementById('email').value = saved; connectWithEmail(saved); }
      } catch {}
    })();
  </script>
</body>
</html>
