<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Notification Receiver</title>
  <style>
    body { font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial; margin: 16px; }
    input, button { font-size: 14px; padding: 8px; margin: 4px 0; width: 100%; }
    #log { white-space: pre-wrap; height: 240px; overflow: auto; background: #111; color: #0f0; padding: 8px; border-radius: 6px; }
    .row { margin-top: 8px; }
  </style>
</head>
<body>
  <h2>Notification Receiver</h2>
  <div class="row">
    <label>Your Email</label>
    <input id="email" placeholder="you@example.com" />
  </div>
  <div class="row">
    <label>Playground Resolve URL</label>
    <input id="resolveUrl" placeholder="https://playground.example.com" />
  </div>
  <button id="connectBtn">Connect</button>

  <h3>Log</h3>
  <div id="log"></div>

  <script>
    const logEl = document.getElementById('log');
    function log(msg) { logEl.textContent += '\n' + new Date().toISOString() + ' ' + msg; logEl.scrollTop = logEl.scrollHeight; }

    let ws;
    async function connect() {
      const email = document.getElementById('email').value.trim();
      const resolveUrl = document.getElementById('resolveUrl').value.trim();
      if (!email || !resolveUrl) { alert('Enter email and resolve URL'); return; }
      // Resolve flow: GET /api/channel/resolve/{id}?email=... in future; for now, call playground /api/resolve by looking up a code by email
      // Simplified: ask playground devinit to show developer ID and rely on admin to have ensured subscription
      // Keep using resolveCode path for now if needed
      const desc = await fetch(new URL('/api/resolve-email', resolveUrl).toString(), {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email })
      }).then(r=>r.json()).catch(()=>null);
      if (!desc) return;
      log('Resolved: ' + JSON.stringify(desc));
      const base = desc.base_url;
      const wsProto = base.startsWith('https') ? 'wss' : 'ws';
      const url = new URL(base);
      const sockUrl = `${wsProto}://${url.host}/v1/socket?user_id=${encodeURIComponent(desc.user_id)}`;
      ws = new WebSocket(sockUrl);
      ws.onopen = () => log('WS open');
      ws.onmessage = (ev) => {
        log('WS message: ' + ev.data);
        try {
          const data = JSON.parse(ev.data);
          if (data && data.title) window.receiver.showNotification(data);
        } catch {}
      };
      ws.onclose = (e) => log(`WS closed code=${e.code} reason=${e.reason}`);
      ws.onerror = (e) => {
        try { log('WS error: ' + (e.message || JSON.stringify(e))); } catch { log('WS error'); }
      };
    }

    document.getElementById('connectBtn').addEventListener('click', connect);
  </script>
</body>
</html>
