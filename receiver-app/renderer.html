<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Routed Receiver</title>
  <style>
    body { font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial; margin: 16px; }
    header { display:flex; align-items:center; gap:8px; }
    header img { width: 18px; height: 18px; }
    .ver { font-size: 12px; opacity: .6; margin-left: 6px; }
    input, button { font-size: 14px; padding: 8px; margin: 4px 0; width: 100%; }
    #log { white-space: pre-wrap; height: 240px; overflow: auto; background: #111; color: #0f0; padding: 8px; border-radius: 6px; }
    .row { margin-top: 8px; }
    #toast { position: fixed; top: 20px; right: 20px; background: rgba(17,17,17,0.95); color:#fff; padding:12px 14px; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,0.3); display:none; max-width: 320px; }
    #toast .t-title { font-weight:600; margin-bottom:4px; }
  </style>
</head>
<body>
  <header>
    <img src="routed_icon.png" alt="Routed" />
    <h2 style="margin:0; display:flex; align-items:center; gap:6px; flex:1">Routed <span id="appVer" class="ver"></span></h2>
    <button id="quitBtn" style="font-size:12px; padding:4px 8px">Quit</button>
  </header>
  <div class="row" style="opacity:.7">Before connecting, we’ll check your server health.</div>
  <div class="row" id="health">Checking server…</div>
  <div class="row">
    <label>Your Phone</label>
    <input id="phone" placeholder="+14155551234" />
  </div>
  <button id="connectBtn" disabled>Connect</button>

  <div class="row" style="margin-top:16px">
    <div style="display:flex; gap:8px; border-bottom:1px solid #ddd; padding-bottom:6px">
      <button id="tabClient" style="flex:1">Client</button>
      <button id="tabDev" style="flex:1">Developer</button>
      <button id="tabApi" style="flex:1">API</button>
      <button id="tabSettings" title="Settings" style="width:42px">⚙︎</button>
    </div>
  </div>
  <div id="toast"><div class="t-title"></div><div class="t-body"></div></div>

  <div id="clientTab" class="row">
    <h3>Notifications</h3>
    <div id="status"></div>
    <div id="notifList" style="margin-top:8px; display:flex; flex-direction:column; gap:8px"></div>
  </div>

  <div id="devTab" class="row" style="display:none">
    <h3>Developer</h3>
    <div id="devInfo" style="background:#f6f6f6; padding:8px; border-radius:6px; display:flex; gap:8px; align-items:center; justify-content:space-between">
      <div>
        <div style="font-size:12px; opacity:.7">Developer ID</div>
        <div id="devId" style="font-family:monospace">Not created</div>
      </div>
      <button id="provisionBtn">Generate</button>
    </div>

    <div class="row">
      <label>New Channel</label>
      <div style="display:flex; gap:8px">
        <input id="newChannelName" placeholder="e.g., QA Team" />
        <button id="createChannelBtn">Create</button>
      </div>
    </div>

    <div class="row">
      <label>Channel</label>
      <select id="channelSelect"></select>
    </div>

    <div class="row">
      <label>Add Phone Numbers (comma or space separated)</label>
      <input id="addPhones" placeholder="+14155551234, +14155559876" />
      <button id="addUsersBtn">Add to Channel</button>
    </div>

    <div class="row">
      <label>Message</label>
      <input id="messageText" placeholder="Type your message" />
      <button id="sendBtn">Send to Channel</button>
    </div>
    <div class="row">
      <h4 style="margin:8px 0 4px">Logs</h4>
      <div style="display:flex; gap:8px; align-items:center; margin-bottom:6px">
        <button id="clearLogsBtn">Clear</button>
        <button id="copyLogsBtn">Copy</button>
      </div>
      <pre id="devlog" style="height:200px; overflow:auto; background:#0b0b0b; color:#9be37f; padding:8px; border-radius:8px"></pre>
    </div>
  </div>

  <div id="apiTab" class="row" style="display:none">
    <h3>API Docs</h3>
    <div class="row" style="background:#f6f6f6; padding:12px; border-radius:8px">
      <div style="margin-bottom:8px">Send a message via HTTPS:</div>
      <pre id="curlCmd" style="white-space:pre-wrap; background:#0b0b0b; color:#9be37f; padding:8px; border-radius:8px"></pre>
      <div style="display:flex; gap:8px; align-items:center; margin-top:6px">
        <button id="copyCurlBtn">Copy</button>
        <span style="font-size:12px; opacity:.7">Replace placeholders if empty.</span>
      </div>
      <div style="font-size:12px; opacity:.8; margin-top:10px">
        Endpoint: <code>POST /v1/messages</code><br/>
        Headers: <code>Authorization: Bearer &lt;API_KEY&gt;</code>, <code>Content-Type: application/json</code><br/>
        Body: <code>{ "topic": "runs.finished", "title": "Routed", "body": "Hello", "payload": null }</code>
      </div>
    </div>
  </div>

  <div id="settingsTab" class="row" style="display:none">
    <h3>Settings</h3>
    <div class="row" style="display:flex; gap:8px; align-items:center">
      <input id="serverUrl" placeholder="https://your.server" style="flex:1" />
      <button id="saveServerBtn" style="white-space:nowrap">Save Server</button>
    </div>
    <div class="row" style="font-size:12px; opacity:.7">Default: https://routed.onrender.com</div>
  </div>

  <script>
    const logEl = document.getElementById('log');
    function log(msg) { logEl.textContent += '\n' + new Date().toISOString() + ' ' + msg; logEl.scrollTop = logEl.scrollHeight; }

    // Configurable server base URL (persisted via main process)
    let BASE_URL = 'https://routed.onrender.com';
    const healthEl = document.getElementById('health');
    const connectBtn = document.getElementById('connectBtn');

    function fetchTimeout(resource, options = {}, timeoutMs = 3000) {
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeoutMs);
      return fetch(resource, { ...options, signal: controller.signal })
        .finally(() => clearTimeout(id));
    }

    async function checkHealth() {
      try {
        // Fast-path deep health with 2s timeout
        let url = new URL('/v1/health/deep', BASE_URL).toString();
        devlog(`[health] GET ${url}`);
        let res = await fetchTimeout(url, { cache: 'no-store' }, 2000);
        let json = null;
        const ct = (res.headers.get('content-type') || '').toLowerCase();
        if (ct.includes('application/json')) { try { json = await res.json(); } catch {} }
        if (res.ok && json && json.ok) {
          healthEl.innerHTML = `Server: <span style="color:#22c55e">OK</span>`;
          connectBtn.disabled = false;
          devlog('[health] ok via /v1/health/deep');
          return true;
        }
        // Fallback: simple /healthz with 2s timeout
        url = new URL('/healthz', BASE_URL).toString();
        devlog(`[health] GET ${url}`);
        res = await fetchTimeout(url, { cache: 'no-store' }, 2000);
        if (res.ok) {
          healthEl.innerHTML = `Server: <span style="color:#22c55e">OK</span>`;
          connectBtn.disabled = false;
          devlog('[health] ok via /healthz');
          return true;
        }
        healthEl.textContent = `Health check failed. Status ${res.status}`;
        connectBtn.disabled = false;
        devlog(`[health] failed status=${res.status}`);
        return false;
      } catch (e) {
        const msg = (e && (e.name === 'AbortError' ? 'timeout' : e.message)) || String(e);
        healthEl.textContent = `Health check error: ${msg}`;
        connectBtn.disabled = false;
        devlog(`[health] error: ${msg}`);
        return false;
      }
    }

    async function preflightOrFail() {
      const ok = await checkHealth();
      if (!ok) {
        showToast('Cannot connect', 'Server is unreachable. Check Settings → Server and try again.');
        return false;
      }
      return true;
    }
    let ws;
    const notifList = document.getElementById('notifList');
    const devlogEl = document.getElementById('devlog');
    function devlog(msg) {
      if (!devlogEl) return;
      const line = `${new Date().toISOString()} ${msg}`;
      devlogEl.textContent += (devlogEl.textContent ? '\n' : '') + line;
      devlogEl.scrollTop = devlogEl.scrollHeight;
      try { window.receiver.debugLog(line); } catch {}
    }
    function addNotificationCard(data) {
      const card = document.createElement('div');
      card.style.border = '1px solid #ddd';
      card.style.borderRadius = '8px';
      card.style.padding = '8px';
      card.innerHTML = `<div style="font-weight:600">${(data.title||'').replace(/</g,'&lt;')}</div><div>${(data.body||'').replace(/</g,'&lt;')}</div>`;
      notifList.prepend(card);
    }
    function showToast(title, body) {
      const el = document.getElementById('toast');
      el.querySelector('.t-title').textContent = title || 'Notification';
      el.querySelector('.t-body').textContent = body || '';
      el.style.display = 'block';
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => { el.style.display = 'none'; }, 3500);
    }
    function makeWsUrl(base, userId, path) {
      const url = new URL(base);
      const wsProto = url.protocol === 'https:' ? 'wss' : 'ws';
      return `${wsProto}://${url.host}${path}?user_id=${encodeURIComponent(userId)}`;
    }

    async function connectWithPhone(phone) {
      try {
        // Provision tenant if needed and ensure phone user on hub
        let d = await window.receiver.devGet();
        if (!d || !d.tenantId) { devlog('dev:provision (pre-connect)'); await window.receiver.devProvision(); d = await window.receiver.devGet(); }
        if (!d || !d.tenantId) { devlog('dev:provision failed'); return; }
        const ensured = await window.receiver.adminUsersEnsure({ tenantId: d.tenantId, phone, topic: 'runs.finished' });
        if (!ensured || !ensured.userId) { devlog('users:ensure failed'); return; }
        const userId = ensured.userId;
        devlog(`Resolved: base_url=${BASE_URL} user_id=${userId}`);
        const base = BASE_URL;
        const urlV1 = makeWsUrl(base, userId, '/v1/socket');
        const urlAlt = makeWsUrl(base, userId, '/socket');

        async function tryConnect(urls) {
          if (!urls.length) { log('All WS endpoints failed'); return; }
          const next = urls[0];
          devlog(`WS connecting: ${next}`);
          return new Promise((resolve) => {
            let opened = false;
            const candidate = new WebSocket(next);
            candidate.onopen = () => {
              opened = true;
              ws = candidate;
              devlog('WS open');
              document.getElementById('status').textContent = 'Connected';
              resolve(null);
            };
            candidate.onmessage = (ev) => {
              devlog(`WS message: ${ev.data}`);
              try {
                const data = JSON.parse(ev.data);
                if (data && data.type === 'hello') {
                  // handshake ok
                } else if (data 66 data.title) {
                  // Trigger native notification (main process) and update in-app list only
                  window.receiver.showNotification(data);
                  addNotificationCard(data);
                }
              } catch {}
            };
            candidate.onclose = (e) => {
              if (!opened) {
                devlog(`WS close before open (${next}) code=${e.code}`);
                tryConnect(urls.slice(1)).then(resolve);
              } else {
                devlog(`WS closed code=${e.code} reason=${e.reason}`);
                document.getElementById('status').textContent = 'Disconnected';
              }
            };
            candidate.onerror = (e) => {
              try { devlog(`WS error on ${next}: ` + (e.message || JSON.stringify(e))); } catch { devlog('WS error'); }
            };
          });
        }

        await tryConnect([urlAlt, urlV1]);
        devlog('autoconnect ok for phone ' + phone);
      } catch (e) {
        devlog('Connect failed: ' + (e && e.message ? e.message : e));
      }
    }

    document.getElementById('connectBtn').addEventListener('click', async () => {
      const phone = document.getElementById('phone').value.trim();
      if (!phone) { alert('Enter your phone'); return; }
      try { localStorage.setItem('ROUTED_PHONE', phone); } catch {}
      const ok = await preflightOrFail();
      if (!ok) return;
      await connectWithPhone(phone);
    });

    // Tabs
    const clientTab = document.getElementById('clientTab');
    const devTab = document.getElementById('devTab');
    const apiTab = document.getElementById('apiTab');
    const settingsTab = document.getElementById('settingsTab');
    function showTab(which) {
      clientTab.style.display = which === 'client' ? '' : 'none';
      devTab.style.display = which === 'dev' ? '' : 'none';
      apiTab.style.display = which === 'api' ? '' : 'none';
      settingsTab.style.display = which === 'settings' ? '' : 'none';
    }
    document.getElementById('tabClient').addEventListener('click', () => showTab('client'));
    document.getElementById('tabDev').addEventListener('click', () => showTab('dev'));
    document.getElementById('tabApi').addEventListener('click', () => { updateCurl(); showTab('api'); });
    document.getElementById('tabSettings').addEventListener('click', () => showTab('settings'));

    // Dev console handlers
    const devIdEl = document.getElementById('devId');
    const channelSelect = document.getElementById('channelSelect');
    async function loadChannels() {
      const d = await window.receiver.devGet();
      if (!d || !d.tenantId) return;
      const ch = await window.receiver.adminChannelsList(d.tenantId);
      channelSelect.innerHTML = '';
      ch.forEach((c) => {
        const opt = document.createElement('option');
        opt.value = JSON.stringify({ topic: c.topic });
        opt.textContent = `${c.name} (${c.short_id})`;
        channelSelect.appendChild(opt);
      });
    }
    async function refreshDevInfo() {
      const d = await window.receiver.devGet();
      devIdEl.textContent = d ? (d.tenantId || 'Unknown') : 'Not created';
      await loadChannels();
    }
    document.getElementById('provisionBtn').addEventListener('click', async () => {
      await window.receiver.devProvision();
      await refreshDevInfo();
    });
    document.getElementById('createChannelBtn').addEventListener('click', async () => {
      const d = await window.receiver.devGet();
      if (!d || !d.tenantId) { alert('Generate Developer ID first'); return; }
      const name = (document.getElementById('newChannelName').value || '').trim();
      if (!name) { alert('Enter a channel name'); return; }
      await window.receiver.adminChannelsCreate({ tenantId: d.tenantId, name, topic: 'runs.finished' });
      document.getElementById('newChannelName').value = '';
      await loadChannels();
    });
    document.getElementById('addUsersBtn').addEventListener('click', async () => {
      const d = await window.receiver.devGet();
      if (!d || !d.tenantId) { alert('Generate Developer ID first'); return; }
      const selected = channelSelect.value ? JSON.parse(channelSelect.value) : null;
      if (!selected) { alert('Choose a channel'); return; }
      const raw = (document.getElementById('addPhones').value || '').trim();
      if (!raw) { alert('Enter phone numbers'); return; }
      const phones = raw.split(/[,\s]+/).map((p) => p.trim()).filter(Boolean);
      for (const phone of phones) {
        await window.receiver.adminUsersEnsure({ tenantId: d.tenantId, phone, topic: selected.topic });
      }
      document.getElementById('addPhones').value = '';
      alert('Added');
    });
    document.getElementById('sendBtn').addEventListener('click', async () => {
      const selected = channelSelect.value ? JSON.parse(channelSelect.value) : null;
      if (!selected) { alert('Choose a channel'); return; }
      const text = (document.getElementById('messageText').value || '').trim();
      if (!text) { alert('Enter a message'); return; }
      await window.receiver.devSendMessage({ topic: selected.topic, title: 'Routed', body: text, payload: null });
      document.getElementById('messageText').value = '';
    });

    async function ensureDevChannelForPhone(phone) {
      try {
        let d = await window.receiver.devGet();
        if (!d) {
          await window.receiver.devProvision();
          d = await window.receiver.devGet();
        }
        if (!d || !d.tenantId) return;
        let ch = await window.receiver.adminChannelsList(d.tenantId);
        if (!Array.isArray(ch) || ch.length === 0) {
          await window.receiver.adminChannelsCreate({ tenantId: d.tenantId, name: 'Default', topic: 'runs.finished' });
          ch = await window.receiver.adminChannelsList(d.tenantId);
        }
        if (Array.isArray(ch) && ch.length > 0) {
          const first = ch[0];
          channelSelect.innerHTML = '';
          const opt = document.createElement('option');
          opt.value = JSON.stringify({ topic: first.topic });
          opt.textContent = `${first.name} (${first.short_id})`;
          channelSelect.appendChild(opt);
          // Do NOT re-ensure here to avoid duplicate subscriptions; connectWithPhone already ensured
        }
      } catch {}
    }

    function updateCurl() {
      (async () => {
        try {
          const d = await window.receiver.devGet();
          const apiKey = d && d.apiKey ? d.apiKey : '$API_KEY';
          let topic = 'runs.finished';
          try {
            const selected = channelSelect.value ? JSON.parse(channelSelect.value) : null;
            if (selected && selected.topic) topic = selected.topic;
          } catch {}
          const cmd = [
            'curl -X POST',
            "-H 'Authorization: Bearer " + apiKey + "'",
            "-H 'Content-Type: application/json'",
            "-d '{" +
              "\"topic\": \"" + topic + "\", " +
              "\"title\": \"Routed\", " +
              "\"body\": \"Hello from CLI\", " +
              "\"payload\": null'",
            'https://routed.onrender.com/v1/messages'
          ].join(' ');
          document.getElementById('curlCmd').textContent = cmd;
        } catch {}
      })();
    }

    (async () => {
      // Load server URL
      try {
        BASE_URL = await window.receiver.devGetBaseUrl() || BASE_URL;
        const su = document.getElementById('serverUrl');
        if (su) su.value = BASE_URL;
      } catch {}
      // Set version label
      try {
        const v = await window.receiver.appVersion();
        const el = document.getElementById('appVer');
        if (el && v) el.textContent = `v${v}`;
      } catch {}

      await checkHealth();
      try {
        const saved = localStorage.getItem('ROUTED_PHONE');
        if (saved) {
          document.getElementById('phone').value = saved;
          await connectWithPhone(saved);
          await ensureDevChannelForPhone(saved);
          showTab('dev');
          try { document.getElementById('messageText')?.focus(); } catch {}
        }
        // Debug: log sockets snapshot to help diagnose delivery
        try {
          const snap = await window.receiver.adminSockets();
          await window.receiver.debugLog('sockets snapshot: ' + JSON.stringify(snap));
        } catch {}
      } catch {}
      await refreshDevInfo();
    })();
    document.getElementById('saveServerBtn').addEventListener('click', async () => {
      try {
        const su = document.getElementById('serverUrl');
        const url = (su.value || '').trim();
        if (!url) { alert('Enter server URL'); return; }
        BASE_URL = await window.receiver.devSetBaseUrl(url) || url;
        devlog('Saved server: ' + BASE_URL);
        await checkHealth();
      } catch {}
    });
    document.getElementById('clearLogsBtn').addEventListener('click', () => { if (devlogEl) devlogEl.textContent=''; });
    document.getElementById('copyLogsBtn').addEventListener('click', async () => {
      try { await navigator.clipboard.writeText(devlogEl.textContent || ''); showToast('Copied logs',''); } catch {}
    });
    document.getElementById('copyCurlBtn').addEventListener('click', async () => {
      try { await navigator.clipboard.writeText(document.getElementById('curlCmd').textContent || ''); showToast('Copied curl',''); } catch {}
    });
    document.getElementById('quitBtn').addEventListener('click', () => { try { window.receiver.appQuit(); } catch {} });
  </script>
</body>
</html>
