<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Routed</title>
  <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
  <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-exp.min.css">
  <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-icons.min.css">
  <style>
    body, html { font-size: 14px; }
    .tab-item.active { background: #f1f1fc; }
    .tab-item:hover { background: #f8f8f8; }
    .btn .icon { vertical-align: middle; }
    #app-container { display: flex; height: 100vh; }
    #tabs-container { width: 150px; background-color: #f8f9fa; padding-top: 20px; }
    #content-container { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; align-items: flex-start; }
    .tab-item { cursor: pointer; padding: 10px; border-bottom: 1px solid #eee; }
    .tab-item .icon { margin-right: 10px; }
    .tab-content { display: none; width: 100%; }
    .tab-content.active { display: block; }
    #phone-login-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    #phone-login-dialog { background: white; padding: 40px; border-radius: 8px; width: 400px; }
    .empty { border: 1px solid #e5e5e5; border-radius: 4px; padding: 20px; text-align: center; margin-top: 20px; }
    .log-entry { font-family: monospace; white-space: pre-wrap; word-break: break-all; }
    .form-group:not(:last-child) { margin-bottom: 1rem; }
    .toast { display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 5px; z-index: 2000; }
    .status-dot { height: 10px; width: 10px; background-color: #bbb; border-radius: 50%; display: inline-block; margin-right: 5px; }
    .status-dot.online { background-color: #32b643; }
    .status-dot.offline { background-color: #ff4136; }
    #server-status { margin-bottom: 20px; }
  </style>
</head>
<body>
  <div id="app-container">
    <div id="tabs-container">
      <div class="tab tab-block">
        <div class="tab-item active" onclick="showTab('channels')"><i class="icon icon-message"></i> Channels</div>
        <div class="tab-item" onclick="showTab('scripts')"><i class="icon icon-scroll"></i> Scripts</div>
        <div class="tab-item" onclick="showTab('account')"><i class="icon icon-people"></i> Account</div>
      </div>
    </div>
    <div id="content-container">
      <!-- Channels Tab -->
      <div id="channels-tab" class="tab-content active">
        <h4>Channels</h4>
        <div id="channels-list" class="my-2"></div>
        <button class="btn btn-primary" onclick="showCreateChannelModal()"><i class="icon icon-plus"></i> Create Channel</button>
        <button class="btn" onclick="showJoinChannelModal()"><i class="icon icon-link"></i> Join Public Channel</button>
        <button class="btn" onclick="showTab('log')"><i class="icon icon-menu"></i> Show App Log</button>
      </div>
      <!-- Scripts Tab -->
      <div id="scripts-tab" class="tab-content">
        <h4>Scripts</h4>
        <div id="scripts-list"></div>
        <button class="btn btn-primary" onclick="showCreateScriptModal()"><i class="icon icon-plus"></i> Create Script</button>
      </div>
      <!-- Account Tab -->
      <div id="account-tab" class="tab-content">
        <h4>Account</h4>
        <p>Confirmed phone: <strong id="confirmed-phone"></strong></p>
        <p>Dev ID: <strong id="dev-id"></strong></p>
        <button class="btn btn-error" id="logout-button"><i class="icon icon-shutdown"></i> Logout</button>
      </div>
      <!-- Log Tab -->
      <div id="log-tab" class="tab-content">
        <h4>App Log</h4>
        <div id="log-output" style="height: 300px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; background: #f5f5f5;"></div>
        <button class="btn mt-2" onclick="copyLog()"><i class="icon icon-copy"></i> Copy Log</button>
        <button class="btn btn-error mt-2" onclick="clearLog()"><i class="icon icon-delete"></i> Clear Log</button>
        <button class="btn mt-2" onclick="showTab('channels')">Back to Channels</button>
      </div>
    </div>
  </div>

  <!-- Phone Login Overlay -->
  <div id="phone-login-overlay">
    <div id="phone-login-dialog">
      <h3 class="text-center">Welcome to Routed</h3>
      <p class="text-center text-gray">Enter your phone to begin.</p>
      <div class="form-group">
        <div class="input-group">
          <select id="country-code" class="form-select" style="flex: 0 0 100px;">
            <option value="+1">+1 (USA)</option>
          </select>
          <input class="form-input" type="tel" id="phone-input" placeholder="5551234567">
        </div>
      </div>
      <button class="btn btn-primary btn-block" id="submit-phone">Continue</button>
      <div id="verify-code-group" style="display: none;" class="mt-2">
        <div class="form-group">
          <input class="form-input" type="text" id="verify-code-input" placeholder="123456">
        </div>
        <button class="btn btn-primary btn-block" id="submit-code">Verify</button>
      </div>
    </div>
  </div>

  <!-- Create Channel Modal -->
  <div class="modal" id="create-channel-modal">
    <a href="#close" class="modal-overlay" aria-label="Close"></a>
    <div class="modal-container">
      <div class="modal-header">
        <a href="#close" class="btn btn-clear float-right" aria-label="Close" onclick="closeModal('create-channel-modal')"></a>
        <div class="modal-title h5">Create New Channel</div>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Channel Name</label>
          <input class="form-input" type="text" id="new-channel-name" placeholder="e.g. My Awesome Alerts">
          <label class="form-label mt-2">Description (optional)</label>
          <textarea class="form-input" id="new-channel-desc" placeholder="What is this channel for?"></textarea>
          <label class="form-checkbox mt-2">
            <input type="checkbox" id="new-channel-public">
            <i class="form-icon"></i> Allow public joining
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="createChannel()">Create</button>
        <button class="btn btn-link" onclick="closeModal('create-channel-modal')">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Channel Details Modal -->
  <div class="modal modal-lg" id="channel-details-modal">
    <a href="#close" class="modal-overlay" aria-label="Close"></a>
    <div class="modal-container">
      <div class="modal-header">
        <a href="#close" class="btn btn-clear float-right" aria-label="Close" onclick="closeModal('channel-details-modal')"></a>
        <div class="modal-title h5" id="channel-details-title">Channel Details</div>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Channel ID</label>
          <div class="input-group">
            <input class="form-input" type="text" id="channel-details-id" readonly>
            <button class="btn input-group-btn" onclick="copyChannelId()"><i class="icon icon-copy"></i></button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Subscribers</label>
          <div id="channel-subscribers-list" style="max-height: 300px; overflow-y: auto;">
            <div class="loading">Loading...</div>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Add Subscriber</label>
          <div class="input-group">
            <input class="form-input" type="tel" id="add-subscriber-phone" placeholder="Phone number">
            <button class="btn btn-primary input-group-btn" onclick="addSubscriber()">Add</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Send Message to All Subscribers</label>
          <div class="input-group">
            <input class="form-input" type="text" id="send-message-text" placeholder="Enter message to send">
            <button class="btn btn-success input-group-btn" onclick="sendChannelMessage()"><i class="icon icon-message"></i> Send</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-link" onclick="closeModal('channel-details-modal')">Close</button>
      </div>
    </div>
  </div>

  <!-- Join Channel Modal -->
  <div class="modal" id="join-channel-modal">
    <a href="#close" class="modal-overlay" aria-label="Close"></a>
    <div class="modal-container">
      <div class="modal-header">
        <a href="#close" class="btn btn-clear float-right" aria-label="Close" onclick="closeModal('join-channel-modal')"></a>
        <div class="modal-title h5">Join Public Channel</div>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Channel Short ID</label>
          <input class="form-input" type="text" id="join-channel-id" placeholder="Enter the 6-character ID">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="joinChannel()">Join</button>
        <button class="btn btn-link" onclick="closeModal('join-channel-modal')">Cancel</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // --- State ----
    let confirmedPhone = null;
    let devState = {};

    // --- Logging ----
    const devlog = (msg) => {
      try {
        console.log(`[renderer] ${msg}`);
        window.receiver.debug.log(msg);
      } catch {}
    }

    // --- Preload/IPC Health ----
    // Warn if the preload script didn't run or IPC is missing
    if (typeof window.receiver === 'undefined') {
      document.addEventListener('DOMContentLoaded', () => {
        try {
          const container = document.getElementById('app-container');
          container.innerHTML = `<div class="empty" style="text-align:left; padding:40px; margin:20px;">
            <h4>Critical Error: Preload script failed to load</h4>
            <p>The app cannot function without its secure IPC bridge.</p>
            <p>This usually happens if <code>preload.js</code> has a syntax error or fails to execute. Please check the main process logs for an error message.</p>
            <p>To view logs:
              <ol>
                <li>Quit the app (Cmd/Ctrl+Q).</li>
                <li>Open a terminal and run: <code>tail -f ${"app.isPackaged ? path.join(app.getPath('userData'), 'routed.log') : path.join(__dirname, 'routed.log')"}</code></li>
                <li>Restart the app.</li>
              </ol>
            </p>
          </div>`;
        } catch {}
      });
    }

    // --- UI ----
    function showTab(tabName) {
      devlog(`showTab: showing tab ${tabName}`);
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
      try {
        document.getElementById(`${tabName}-tab`).classList.add('active');
        const tabItem = document.querySelector(`.tab-item[onclick="showTab('${tabName}')"]`);
        if (tabItem) tabItem.classList.add('active');
      } catch (e) {
        devlog(`showTab error: ${e}`);
      }
    }

    function showModal(id) {
      devlog(`showModal: showing modal ${id}`);
      const modal = document.getElementById(id);
      if (modal) modal.classList.add('active');
    }

    function closeModal(id) {
      devlog(`closeModal: closing modal ${id}`);
      const modal = document.getElementById(id);
      if (modal) modal.classList.remove('active');
    }

    function showCreateChannelModal() { showModal('create-channel-modal'); }
    function showJoinChannelModal() { showModal('join-channel-modal'); }
    function showCreateScriptModal() { showModal('create-script-modal'); }

    // --- Toast Notifications ---
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type === 'error' ? 'toast-error' : 'toast-success'}`;
      toast.style.display = 'block';
      setTimeout(() => { toast.style.display = 'none'; }, 3000);
    }
    
    async function safeInvoke(channel, payload) {
      try {
        const res = await receiver.invoke(channel, payload);
        return (res === undefined || res === null) ? { error: `No response from ${channel}` } : res;
      } catch (e) {
        return { error: e?.message || String(e) };
      }
    }

    // --- Channels ----
    let currentChannelShortId = null;
    
    async function showChannelDetails(shortId, name) {
      devlog(`showChannelDetails: showing details for ${shortId}`);
      currentChannelShortId = shortId;
      
      document.getElementById('channel-details-title').textContent = name;
      document.getElementById('channel-details-id').value = shortId;
      
      showModal('channel-details-modal');
      await fetchChannelSubscribers(shortId);
    }
    
    async function fetchChannelSubscribers(shortId) {
      devlog(`fetchChannelSubscribers: fetching for ${shortId}`);
      const result = await safeInvoke('channels:users', { shortId });
      
      devlog(`fetchChannelSubscribers: result: ${JSON.stringify(result)}`);
      
      const list = document.getElementById('channel-subscribers-list');
      
      if (result.error) {
        list.innerHTML = `<div class="empty"><p>Error loading subscribers</p><p class="text-gray">${result.error}</p></div>`;
        return;
      }
      
      const users = result.users || [];
      
      if (!users.length) {
        list.innerHTML = `<div class="empty"><p>No subscribers yet</p></div>`;
        return;
      }
      
      list.innerHTML = '';
      users.forEach(user => {
        const div = document.createElement('div');
        div.className = 'tile tile-centered my-1';
        const phone = user.phone || user.email || 'Unknown';
        const isCreator = phone === confirmedPhone;
        
        div.innerHTML = `
          <div class="tile-content">
            <div class="tile-title">${phone} ${isCreator ? '<span class="label label-primary ml-2">You</span>' : ''}</div>
            ${user.online ? '<span class="status-dot online"></span> Online' : '<span class="status-dot offline"></span> Offline'}
          </div>
          <div class="tile-action">
            <button class="btn btn-sm btn-error" onclick="removeSubscriber('${shortId}', '${phone}')"><i class="icon icon-cross"></i></button>
          </div>`;
        list.appendChild(div);
      });
    }
    
    async function addSubscriber() {
      const phone = document.getElementById('add-subscriber-phone').value.trim();
      if (!phone) {
        showToast('Phone number is required', 'error');
        return;
      }
      
      devlog(`addSubscriber: adding ${phone} to ${currentChannelShortId}`);
      
      const result = await safeInvoke('channels:subscribe', {
        shortId: currentChannelShortId,
        phone: phone
      });
      
      devlog(`addSubscriber: result: ${JSON.stringify(result)}`);
      
      if (result.ok) {
        document.getElementById('add-subscriber-phone').value = '';
        showToast('Subscriber added!');
        await fetchChannelSubscribers(currentChannelShortId);
      } else {
        showToast(`Error: ${result.error || 'Failed to add subscriber'}`, 'error');
      }
    }
    
    async function removeSubscriber(shortId, phone) {
      if (!confirm(`Remove ${phone} from this channel?`)) return;
      
      devlog(`removeSubscriber: removing ${phone} from ${shortId}`);
      
      const result = await safeInvoke('channels:unsubscribe', {
        shortId: shortId,
        phone: phone
      });
      
      devlog(`removeSubscriber: result: ${JSON.stringify(result)}`);
      
      if (result.ok) {
        showToast('Subscriber removed');
        await fetchChannelSubscribers(shortId);
      } else {
        showToast(`Error: ${result.error || 'Failed to remove subscriber'}`, 'error');
      }
    }
    
    async function sendChannelMessage() {
      const message = document.getElementById('send-message-text').value.trim();
      if (!message) {
        showToast('Message is required', 'error');
        return;
      }
      
      const channelName = document.getElementById('channel-details-title').textContent;
      
      devlog(`sendChannelMessage: sending message to channel ${currentChannelShortId}`);
      
      const result = await safeInvoke('channels:send', {
        shortId: currentChannelShortId,
        title: `Message from ${channelName}`,
        body: message
      });
      
      devlog(`sendChannelMessage: result: ${JSON.stringify(result)}`);
      
      if (result.ok) {
        document.getElementById('send-message-text').value = '';
        showToast('Message sent to all subscribers!');
      } else {
        showToast(`Error: ${result.error || 'Failed to send message'}`, 'error');
      }
    }
    
    function copyChannelId() {
      const id = document.getElementById('channel-details-id').value;
      navigator.clipboard.writeText(id).then(
        () => showToast('Channel ID copied!'),
        () => showToast('Failed to copy', 'error')
      );
    }
    
    async function fetchChannels() {
      devlog('fetchChannels: fetching channels...');
      const result = await safeInvoke('channels:list');

      devlog(`fetchChannels: channels:list result: ${JSON.stringify(result)}`);

      const list = document.getElementById('channels-list');
      list.innerHTML = '';

      if (result.error) {
        list.innerHTML = `<div class="empty"><p>Error</p><p class="text-gray">${result.error}</p></div>`;
        return;
      }

      // Accept both { channels: [...] } and bare [...]
      const channels = Array.isArray(result) ? result : (result.channels || []);

      if (!channels.length) {
        list.innerHTML = `<div class="empty"><p>No channels yet</p><p class="text-gray">Create one or join a public channel.</p></div>`;
        return;
      }

      channels.forEach(ch => {
        const div = document.createElement('div');
        div.className = 'tile my-2';
        div.style.cursor = 'pointer';
        div.innerHTML = `
          <div class="tile-content" onclick="showChannelDetails('${ch.short_id}', '${ch.name.replace(/'/g, "\\'")}')">
            <p class="tile-title h6">${ch.name}</p>
            <p class="tile-subtitle text-gray">${ch.description || `ID: ${ch.short_id}`}</p>
          </div>
          <div class="tile-action">
            <button class="btn btn-sm" onclick="event.stopPropagation(); navigator.clipboard.writeText('${ch.short_id}'); showToast('Copied ID!')"><i class="icon icon-copy"></i> Copy ID</button>
          </div>`;
        list.appendChild(div);
      });
    }

    async function createChannel() {
      devlog('createChannel: creating channel...');
      const name = document.getElementById('new-channel-name').value;
      const description = document.getElementById('new-channel-desc').value;
      const allow_public = document.getElementById('new-channel-public').checked;
      if (!name) { showToast('Channel name is required', 'error'); return; }

      devlog(`createChannel: creating channel: ${name}`);

      // FIX: use camelCase keys expected by main
      // Don't auto-subscribe creator to avoid transaction issues
      const result = await safeInvoke('channels:create', {
        name,
        description,
        allowPublic: allow_public
        // Removed creatorPhone to prevent transaction errors
      });

      devlog(`createChannel: channels:create result: ${JSON.stringify(result)}`);

      if (result.ok) {
        closeModal('create-channel-modal');
        fetchChannels();
        showToast('Channel created successfully!');
      } else {
        showToast(`Error: ${result?.error || 'No response from server'}`, 'error');
      }
    }

    async function joinChannel() {
      devlog('joinChannel: joining channel...');
      const short_id = document.getElementById('join-channel-id').value;
      if (!short_id) { showToast('Channel ID is required', 'error'); return; }

      // FIX: call an existing handler; join public channels by short ID
      const result = await safeInvoke('public:channels:join', {
        shortId: short_id,
        phone: confirmedPhone
      });

      devlog(`joinChannel: public:channels:join result: ${JSON.stringify(result)}`);

      if (result && result.ok) {
        closeModal('join-channel-modal');
        fetchChannels();
        showToast('Joined channel!');
      } else {
        showToast(`Error: ${result?.error || 'No response from server'}`, 'error');
      }
    }

    // --- App Log ---
    async function fetchLog() {
      try {
        devlog('fetchLog: reading app logs');
        const result = await receiver.invoke('app:logs:read', { maxChars: 50000 });
        const output = document.getElementById('log-output');
        if (result.ok) {
          output.textContent = result.content || '(empty log)';
          output.scrollTop = output.scrollHeight;
        } else {
          output.textContent = `Error reading log: ${result.error}`;
        }
      } catch (e) {
        devlog(`fetchLog error: ${e}`);
        document.getElementById('log-output').textContent = `Error: ${e.message}`;
      }
    }
    
    function copyLog() {
      const log = document.getElementById('log-output').textContent;
      navigator.clipboard.writeText(log).then(() => showToast('Log copied!'), () => showToast('Copy failed', 'error'));
    }

    function clearLog() {
      document.getElementById('log-output').textContent = '';
    }

    // --- Authentication ----
    async function initAuth() {
      devlog('initAuth: starting');
      const dev = await receiver.invoke('dev:get');
      devState = dev || {};
      confirmedPhone = devState.verifiedPhone;
      devlog(`initAuth: phone=${confirmedPhone ? 'yes' : 'no'}`);

      if (confirmedPhone) {
        document.getElementById('phone-login-overlay').style.display = 'none';
        document.getElementById('confirmed-phone').textContent = confirmedPhone;
        document.getElementById('dev-id').textContent = devState.devId || 'N/A';

        // Disable create channel button if no devId
        const createChannelBtn = document.querySelector("button[onclick=\"showCreateChannelModal()\"]");
        if (devState.devId) {
          createChannelBtn.disabled = false;
        } else {
          createChannelBtn.disabled = true;
        }

        document.getElementById('tabs-container').style.opacity = 1;
        document.getElementById('content-container').style.opacity = 1;
        fetchChannels();
      } else {
        document.getElementById('phone-login-overlay').style.display = 'flex';
        document.getElementById('tabs-container').style.opacity = 0.3;
        document.getElementById('content-container').style.opacity = 0.3;
      }

      document.getElementById('submit-phone').addEventListener('click', async () => {
        const phone = document.getElementById('phone-input').value.trim();
        if (!phone) { showToast('Phone number is required.', 'error'); return; }
        
        devlog('auth: sending phone for verification');
        const result = await receiver.invoke('verify:start', { phone });
        if (result.ok) {
          showToast('Verification code sent.');
          document.getElementById('verify-code-group').style.display = 'block';
        } else {
          showToast(`Error: ${result.error}`, 'error');
        }
      });
      
      document.getElementById('submit-code').addEventListener('click', async () => {
        const phone = document.getElementById('phone-input').value.trim();
        const code = document.getElementById('verify-code-input').value.trim();
        if (!code) { showToast('Verification code is required.', 'error'); return; }

        devlog('auth: sending code for verification');
        const result = await receiver.invoke('verify:check', { phone, code });
        if (result.ok) {
          showToast('Verification successful!');
          devlog('auth: verification successful, re-initializing');
          initAuth();
        } else {
          showToast(`Error: ${result.error}`, 'error');
        }
      });

      document.getElementById('logout-button').addEventListener('click', async () => {
        devlog('logout: starting');
        try {
          const ok = await receiver.invoke('auth:logout');
          devlog(`logout: invoke result ok=${ok}`);
          confirmedPhone = null;
          devState = {};
          document.getElementById('confirmed-phone').textContent = '';
          initAuth();
          showToast('Logged out.');
        } catch (e) {
          devlog(`logout: invoke error: ${e}`);
          showToast(`Logout failed: ${e.message}`, 'error');
        }
      });
    }

    // --- Init ---
    document.addEventListener('DOMContentLoaded', () => {
      devlog('DOMContentLoaded: starting init');
      initAuth();
      showTab('channels'); // default tab
      
      // Attach event listeners for log buttons
      document.querySelector('button[onclick="copyLog()"]').addEventListener('click', copyLog);
      document.querySelector('button[onclick="clearLog()"]').addEventListener('click', clearLog);
    });
  </script>
</body>
</html>
