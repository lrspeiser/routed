<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Routed</title>
  <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
  <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-exp.min.css">
  <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-icons.min.css">
  <style>
    body, html { font-size: 14px; }
    .tab-item.active { background: #f1f1fc; }
    .tab-item:hover { background: #f8f8f8; }
    .btn .icon { vertical-align: middle; }
    #app-container { display: flex; height: 100vh; }
    #tabs-container { width: 150px; background-color: #f8f9fa; padding-top: 20px; }
    #content-container { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; align-items: flex-start; }
    .tab-item { cursor: pointer; padding: 10px; border-bottom: 1px solid #eee; }
    .tab-item .icon { margin-right: 10px; }
    .tab-content { display: none; width: 100%; }
    .tab-content.active { display: block; }
    #phone-login-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    #phone-login-dialog { background: white; padding: 40px; border-radius: 8px; width: 400px; }
    .empty { border: 1px solid #e5e5e5; border-radius: 4px; padding: 20px; text-align: center; margin-top: 20px; }
    .log-entry { font-family: monospace; white-space: pre-wrap; word-break: break-all; }
    .form-group:not(:last-child) { margin-bottom: 1rem; }
    .toast { display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 5px; z-index: 2000; }
    .status-dot { height: 10px; width: 10px; background-color: #bbb; border-radius: 50%; display: inline-block; margin-right: 5px; }
    .status-dot.online { background-color: #32b643; }
    .status-dot.offline { background-color: #ff4136; }
    #server-status { margin-bottom: 20px; }
    
    /* Enhanced Channel Management Styles */
    .channel-card {
      border: 1px solid #e7e9ed;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      background: white;
      transition: box-shadow 0.2s;
    }
    .channel-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .channel-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 12px;
    }
    .channel-title {
      font-size: 16px;
      font-weight: 600;
      color: #303742;
    }
    .channel-badge {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      margin-left: 8px;
    }
    .badge-public {
      background: #e7f5ff;
      color: #0969da;
    }
    .badge-private {
      background: #fff3cd;
      color: #856404;
    }
    .channel-stats {
      display: flex;
      gap: 20px;
      margin: 12px 0;
      font-size: 13px;
      color: #6c757d;
    }
    .channel-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .subscriber-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #e7e9ed;
      border-radius: 4px;
      padding: 8px;
    }
    .subscriber-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      margin-bottom: 4px;
      background: #f8f9fa;
      border-radius: 4px;
    }
    .message-composer {
      border: 1px solid #e7e9ed;
      border-radius: 8px;
      padding: 16px;
      background: #f8f9fa;
      margin-top: 16px;
    }
    .quick-actions {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    .stats-overview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: white;
      border: 1px solid #e7e9ed;
      border-radius: 8px;
      padding: 16px;
      text-align: center;
    }
    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: #303742;
    }
    .stat-label {
      font-size: 14px;
      color: #6c757d;
      margin-top: 4px;
    }
    .manage-tab-content { display: none; }
  </style>
</head>
<body>
  <div id="app-container">
    <div id="tabs-container">
      <div class="tab tab-block">
        <div class="tab-item active" onclick="showTab('channels')"><i class="icon icon-message"></i> Channels</div>
        <div class="tab-item" onclick="showTab('scripts')"><i class="icon icon-scroll"></i> Scripts</div>
        <div class="tab-item" onclick="showTab('account')"><i class="icon icon-people"></i> Account</div>
      </div>
    </div>
    <div id="content-container">
      <!-- Channels Tab -->
      <div id="channels-tab" class="tab-content active">
        <h4>Channel Management</h4>
        
        <!-- Stats Overview -->
        <div class="stats-overview">
          <div class="stat-card">
            <div class="stat-value" id="total-channels">0</div>
            <div class="stat-label">Total Channels</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="total-subscribers">0</div>
            <div class="stat-label">Total Subscribers</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="messages-sent">0</div>
            <div class="stat-label">Messages Sent</div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
          <button class="btn btn-primary" onclick="showCreateChannelModal()">
            <i class="icon icon-plus"></i> Create Channel
          </button>
          <button class="btn" onclick="showJoinChannelModal()">
            <i class="icon icon-link"></i> Join Public Channel
          </button>
          <button class="btn" onclick="refreshChannels()">
            <i class="icon icon-refresh"></i> Refresh
          </button>
          <button class="btn" onclick="showTab('log')">
            <i class="icon icon-menu"></i> Show App Log
          </button>
        </div>

        <!-- Channels List -->
        <div id="my-channels">
          <h5>My Channels</h5>
          <div id="channels-container">
            <!-- Channel cards will be inserted here -->
          </div>
        </div>
        
        <!-- Legacy list for compatibility -->
        <div id="channels-list" class="my-2" style="display: none;"></div>
      </div>
      <!-- Scripts Tab -->
      <div id="scripts-tab" class="tab-content">
        <h4>Scripts</h4>
        <div id="scripts-list"></div>
        <button class="btn btn-primary" onclick="showCreateScriptModal()"><i class="icon icon-plus"></i> Create Script</button>
      </div>
      <!-- Account Tab -->
      <div id="account-tab" class="tab-content">
        <h4>Account</h4>
        <p>Confirmed phone: <strong id="confirmed-phone"></strong></p>
        <p>Dev ID: <strong id="dev-id"></strong></p>
        <button class="btn btn-error" id="logout-button"><i class="icon icon-shutdown"></i> Logout</button>
      </div>
      <!-- Log Tab -->
      <div id="log-tab" class="tab-content">
        <h4>App Log</h4>
        <div id="log-output" style="height: 300px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; background: #f5f5f5;"></div>
        <button class="btn mt-2" onclick="copyLog()"><i class="icon icon-copy"></i> Copy Log</button>
        <button class="btn btn-error mt-2" onclick="clearLog()"><i class="icon icon-delete"></i> Clear Log</button>
        <button class="btn mt-2" onclick="showTab('channels')">Back to Channels</button>
      </div>
    </div>
  </div>

  <!-- Phone Login Overlay -->
  <div id="phone-login-overlay">
    <div id="phone-login-dialog">
      <h3 class="text-center">Welcome to Routed</h3>
      <p class="text-center text-gray">Enter your phone to begin.</p>
      <div class="form-group">
        <div class="input-group">
          <select id="country-code" class="form-select" style="flex: 0 0 100px;">
            <option value="+1">+1 (USA)</option>
          </select>
          <input class="form-input" type="tel" id="phone-input" placeholder="5551234567">
        </div>
      </div>
      <button class="btn btn-primary btn-block" id="submit-phone">Continue</button>
      <div id="verify-code-group" style="display: none;" class="mt-2">
        <div class="form-group">
          <input class="form-input" type="text" id="verify-code-input" placeholder="123456">
        </div>
        <button class="btn btn-primary btn-block" id="submit-code">Verify</button>
      </div>
    </div>
  </div>

  <!-- Create Channel Modal -->
  <div class="modal" id="create-channel-modal">
    <a href="#close" class="modal-overlay" aria-label="Close"></a>
    <div class="modal-container">
      <div class="modal-header">
        <a href="#close" class="btn btn-clear float-right" aria-label="Close" onclick="closeModal('create-channel-modal')"></a>
        <div class="modal-title h5">Create New Channel</div>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Channel Name</label>
          <input class="form-input" type="text" id="new-channel-name" placeholder="e.g. My Awesome Alerts">
          <label class="form-label mt-2">Description (optional)</label>
          <textarea class="form-input" id="new-channel-desc" placeholder="What is this channel for?"></textarea>
          <label class="form-checkbox mt-2">
            <input type="checkbox" id="new-channel-public">
            <i class="form-icon"></i> Allow public joining
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="createChannel()">Create</button>
        <button class="btn btn-link" onclick="closeModal('create-channel-modal')">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Channel Details Modal -->
  <div class="modal modal-lg" id="channel-details-modal">
    <a href="#close" class="modal-overlay" aria-label="Close"></a>
    <div class="modal-container">
      <div class="modal-header">
        <a href="#close" class="btn btn-clear float-right" aria-label="Close" onclick="closeModal('channel-details-modal')"></a>
        <div class="modal-title h5" id="channel-details-title">Channel Details</div>
      </div>
      <div class="modal-body">
        <!-- Tabs for channel sections -->
        <ul class="tab tab-block">
          <li class="tab-item active">
            <a href="#" onclick="showChannelTab('info'); return false;">Info</a>
          </li>
          <li class="tab-item">
            <a href="#" onclick="showChannelTab('scripts'); return false;">Scripts</a>
          </li>
          <li class="tab-item">
            <a href="#" onclick="showChannelTab('subscribers'); return false;">Subscribers</a>
          </li>
        </ul>
        
        <!-- Info Tab -->
        <div id="channel-info-tab" class="channel-tab-content" style="display: block;">
          <div class="form-group">
            <label class="form-label">Channel ID</label>
            <div class="input-group">
              <input class="form-input" type="text" id="channel-details-id" readonly>
              <button class="btn input-group-btn" onclick="copyChannelId()"><i class="icon icon-copy"></i></button>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Send Message to All Subscribers</label>
            <div class="input-group">
              <input class="form-input" type="text" id="send-message-text" placeholder="Enter message to send">
              <button class="btn btn-success input-group-btn" onclick="sendChannelMessage()"><i class="icon icon-message"></i> Send</button>
            </div>
          </div>
        </div>
        
        <!-- Scripts Tab -->
        <div id="channel-scripts-tab" class="channel-tab-content" style="display: none;">
          <div class="form-group">
            <h6>Channel Scripts</h6>
            <p class="text-gray">Create automated scripts that send notifications based on events or schedules.</p>
            <div id="channel-scripts-list" style="max-height: 300px; overflow-y: auto;">
              <div class="empty">No scripts yet</div>
            </div>
            <button class="btn btn-primary mt-2" onclick="showCreateScriptForm()"><i class="icon icon-plus"></i> Create Script</button>
          </div>
          
          <!-- Script Creation Form (initially hidden) -->
          <div id="create-script-form" style="display: none; border-top: 1px solid #ddd; margin-top: 20px; padding-top: 20px;">
            <h6>Create New Script</h6>
            <div class="form-group">
              <label class="form-label">What do you want this script to do?</label>
              <textarea class="form-input" id="script-prompt" rows="4" placeholder="Describe what you want. Examples:
• Send weather alerts when temperature drops below freezing
• Notify me every morning at 8am with today's news
• Alert when a webhook from GitHub mentions a critical issue
• Check stock prices every hour and alert on big changes"></textarea>
              <p class="form-input-hint">Be specific! The AI will determine if this needs webhooks, schedules, or manual triggers.</p>
            </div>
            <div class="form-group">
              <label class="form-label">User Settings (optional)</label>
              <p class="text-gray">Add settings that each subscriber can customize (like their location for weather alerts)</p>
              <div id="script-variables-list"></div>
              <button class="btn btn-sm" onclick="addScriptVariable()"><i class="icon icon-plus"></i> Add Setting</button>
            </div>
            <div class="form-group">
              <button class="btn btn-primary" onclick="createScript()">Create Script</button>
              <button class="btn btn-link" onclick="hideCreateScriptForm()">Cancel</button>
            </div>
          </div>
        </div>
        
        <!-- Subscribers Tab -->
        <div id="channel-subscribers-tab" class="channel-tab-content" style="display: none;">
          <div class="form-group">
            <label class="form-label">Subscribers</label>
            <div id="channel-subscribers-list" style="max-height: 300px; overflow-y: auto;">
              <div class="loading">Loading...</div>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Add Subscriber</label>
            <div class="input-group">
              <select id="add-subscriber-country" class="form-select" style="flex: 0 0 120px;">
                <option value="+1" selected>+1 USA</option>
                <option value="+1">+1 CAN</option>
                <option value="+44">+44 UK</option>
                <option value="+61">+61 AUS</option>
                <option value="+91">+91 IND</option>
                <option value="+86">+86 CHN</option>
                <option value="+81">+81 JPN</option>
                <option value="+49">+49 DEU</option>
                <option value="+33">+33 FRA</option>
                <option value="+39">+39 ITA</option>
                <option value="+34">+34 ESP</option>
                <option value="+52">+52 MEX</option>
                <option value="+55">+55 BRA</option>
                <option value="+7">+7 RUS</option>
                <option value="+82">+82 KOR</option>
                <option value="+31">+31 NLD</option>
                <option value="+46">+46 SWE</option>
                <option value="+47">+47 NOR</option>
                <option value="+358">+358 FIN</option>
                <option value="+45">+45 DNK</option>
                <option value="+353">+353 IRL</option>
                <option value="+972">+972 ISR</option>
                <option value="+65">+65 SGP</option>
                <option value="+852">+852 HKG</option>
                <option value="+64">+64 NZL</option>
                <option value="+27">+27 ZAF</option>
                <option value="+971">+971 UAE</option>
                <option value="+966">+966 SAU</option>
                <option value="+20">+20 EGY</option>
                <option value="+234">+234 NGA</option>
              </select>
              <input class="form-input" type="tel" id="add-subscriber-phone" placeholder="Phone number (e.g., 6502079445)" style="flex: 1;">
              <button class="btn btn-primary input-group-btn" onclick="addSubscriber()">Add</button>
            </div>
            <p class="form-input-hint">Enter phone number without country code</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-link" onclick="closeModal('channel-details-modal')">Close</button>
      </div>
    </div>
  </div>

  <!-- Join Channel Modal -->
  <div class="modal" id="join-channel-modal">
    <a href="#close" class="modal-overlay" aria-label="Close"></a>
    <div class="modal-container">
      <div class="modal-header">
        <a href="#close" class="btn btn-clear float-right" aria-label="Close" onclick="closeModal('join-channel-modal')"></a>
        <div class="modal-title h5">Join Public Channel</div>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Channel Short ID</label>
          <input class="form-input" type="text" id="join-channel-id" placeholder="Enter the 6-character ID">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="joinChannel()">Join</button>
        <button class="btn btn-link" onclick="closeModal('join-channel-modal')">Cancel</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // --- State ----
    let confirmedPhone = null;
    let devState = {};

    // --- Logging ----
    const devlog = (msg) => {
      try {
        console.log(`[renderer] ${msg}`);
        window.receiver.debug.log(msg);
      } catch {}
    }

    // --- Preload/IPC Health ----
    // Warn if the preload script didn't run or IPC is missing
    if (typeof window.receiver === 'undefined') {
      document.addEventListener('DOMContentLoaded', () => {
        try {
          const container = document.getElementById('app-container');
          container.innerHTML = `<div class="empty" style="text-align:left; padding:40px; margin:20px;">
            <h4>Critical Error: Preload script failed to load</h4>
            <p>The app cannot function without its secure IPC bridge.</p>
            <p>This usually happens if <code>preload.js</code> has a syntax error or fails to execute. Please check the main process logs for an error message.</p>
            <p>To view logs:
              <ol>
                <li>Quit the app (Cmd/Ctrl+Q).</li>
                <li>Open a terminal and run: <code>tail -f ${"app.isPackaged ? path.join(app.getPath('userData'), 'routed.log') : path.join(__dirname, 'routed.log')"}</code></li>
                <li>Restart the app.</li>
              </ol>
            </p>
          </div>`;
        } catch {}
      });
    }

    // --- UI ----
    function showTab(tabName) {
      devlog(`showTab: showing tab ${tabName}`);
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
      try {
        document.getElementById(`${tabName}-tab`).classList.add('active');
        const tabItem = document.querySelector(`.tab-item[onclick="showTab('${tabName}')"]`);
        if (tabItem) tabItem.classList.add('active');
        
        // If showing the log tab, fetch the latest logs
        if (tabName === 'log') {
          fetchLog();
        }
      } catch (e) {
        devlog(`showTab error: ${e}`);
      }
    }

    function showModal(id) {
      devlog(`showModal: showing modal ${id}`);
      const modal = document.getElementById(id);
      if (modal) modal.classList.add('active');
    }

    function closeModal(id) {
      devlog(`closeModal: closing modal ${id}`);
      const modal = document.getElementById(id);
      if (modal) modal.classList.remove('active');
    }

    function showCreateChannelModal() { showModal('create-channel-modal'); }
    function showJoinChannelModal() { showModal('join-channel-modal'); }
    function showCreateScriptModal() { showModal('create-script-modal'); }

    // --- Toast Notifications ---
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type === 'error' ? 'toast-error' : 'toast-success'}`;
      toast.style.display = 'block';
      setTimeout(() => { toast.style.display = 'none'; }, 3000);
    }
    
    async function safeInvoke(channel, payload) {
      try {
        const res = await receiver.invoke(channel, payload);
        return (res === undefined || res === null) ? { error: `No response from ${channel}` } : res;
      } catch (e) {
        return { error: e?.message || String(e) };
      }
    }

    // --- Enhanced Channel Management ---
    let currentManagedChannel = null;
    let channelsList = [];
    let messageHistory = [];
    
    // Refresh channels with enhanced UI
    async function refreshChannels() {
      devlog('refreshChannels: fetching channels');
      
      try {
        const result = await receiver.invoke('channels:list');
        
        if (result.channels) {
          channelsList = result.channels;
          renderChannelCards(channelsList);
          updateChannelStats();
          devlog(`refreshChannels: loaded ${channelsList.length} channels`);
        }
      } catch (error) {
        devlog(`refreshChannels error: ${error}`);
        showToast('Failed to load channels', 'error');
      }
      
      // Also update legacy list for compatibility
      await fetchChannels();
    }
    
    // Render channel cards
    function renderChannelCards(channels) {
      const container = document.getElementById('channels-container');
      
      if (!channels || channels.length === 0) {
        container.innerHTML = `
          <div class="empty">
            <p class="empty-title h5">No channels yet</p>
            <p class="empty-subtitle">Create your first channel to get started</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = channels.map(channel => `
        <div class="channel-card" data-channel-id="${channel.short_id}">
          <div class="channel-header">
            <div>
              <span class="channel-title">${escapeHtml(channel.name)}</span>
              <span class="channel-badge ${channel.allow_public ? 'badge-public' : 'badge-private'}">
                ${channel.allow_public ? 'Public' : 'Private'}
              </span>
            </div>
            <div>
              <code class="text-gray">${channel.short_id}</code>
            </div>
          </div>
          
          ${channel.description ? `<p class="text-gray">${escapeHtml(channel.description)}</p>` : ''}
          
          <div class="channel-stats">
            <span><i class="icon icon-people"></i> <span id="subs-${channel.short_id}">--</span> subscribers</span>
            <span><i class="icon icon-message"></i> ${channel.topic || 'runs.finished'}</span>
          </div>
          
          <div class="channel-actions">
            <button class="btn btn-primary btn-sm" onclick="openChannelManager('${channel.short_id}')">
              <i class="icon icon-edit"></i> Manage
            </button>
            <button class="btn btn-sm" onclick="quickSendMessage('${channel.short_id}')">
              <i class="icon icon-send"></i> Quick Message
            </button>
            <button class="btn btn-sm" onclick="copyChannelLink('${channel.short_id}')">
              <i class="icon icon-link"></i> Copy Link
            </button>
          </div>
        </div>
      `).join('');
      
      // Load subscriber counts
      channels.forEach(channel => {
        loadSubscriberCount(channel.short_id);
      });
    }
    
    // Load subscriber count for a channel
    async function loadSubscriberCount(shortId) {
      try {
        const result = await receiver.invoke('channels:users', { shortId });
        const count = result.users ? result.users.length : 0;
        const element = document.getElementById(`subs-${shortId}`);
        if (element) {
          element.textContent = count;
        }
      } catch (error) {
        devlog(`loadSubscriberCount error for ${shortId}: ${error}`);
      }
    }
    
    // Open enhanced channel manager (replaces showChannelDetails)
    async function openChannelManager(shortId) {
      const channel = channelsList.find(c => c.short_id === shortId);
      if (!channel) {
        // Fallback to old modal if channel not found
        showChannelDetails(shortId, 'Channel');
        return;
      }
      
      currentManagedChannel = channel;
      currentChannelShortId = shortId; // Keep for compatibility
      
      // Show the existing channel details modal with enhanced features
      document.getElementById('channel-details-title').textContent = channel.name;
      document.getElementById('channel-details-id').value = channel.short_id;
      
      showModal('channel-details-modal');
      await fetchChannelSubscribers(shortId);
    }
    
    // Quick send message
    async function quickSendMessage(shortId) {
      const message = prompt('Enter your message:');
      if (!message) return;
      
      try {
        const result = await receiver.invoke('channels:send', {
          shortId: shortId,
          title: 'Quick Update',
          body: message
        });
        
        if (result.ok !== false) {
          showToast('Message sent!');
          updateChannelStats();
        } else {
          showToast(`Failed to send: ${result.error}`, 'error');
        }
      } catch (error) {
        showToast('Failed to send message', 'error');
      }
    }
    
    // Copy channel link
    function copyChannelLink(shortId) {
      const link = `https://routed.app/join/${shortId}`;
      navigator.clipboard.writeText(link).then(() => {
        showToast('Channel link copied!');
      }).catch(() => {
        showToast('Failed to copy link', 'error');
      });
    }
    
    // Update channel stats
    async function updateChannelStats() {
      const totalChannels = channelsList.length;
      document.getElementById('total-channels').textContent = totalChannels;
      
      // Count total subscribers across all channels
      let totalSubscribers = 0;
      for (const channel of channelsList) {
        try {
          const result = await receiver.invoke('channels:users', { 
            shortId: channel.short_id 
          });
          totalSubscribers += (result.users ? result.users.length : 0);
        } catch (error) {
          devlog(`updateChannelStats error: ${error}`);
        }
      }
      document.getElementById('total-subscribers').textContent = totalSubscribers;
      
      // Messages sent (from history)
      document.getElementById('messages-sent').textContent = messageHistory.length;
    }
    
    // Utility: Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // --- Channels (Legacy) ----
    let currentChannelShortId = null;
    
    async function showChannelDetails(shortId, name) {
      devlog(`showChannelDetails: showing details for ${shortId}`);
      currentChannelShortId = shortId;
      
      document.getElementById('channel-details-title').textContent = name;
      document.getElementById('channel-details-id').value = shortId;
      
      showModal('channel-details-modal');
      await fetchChannelSubscribers(shortId);
    }
    
    async function fetchChannelSubscribers(shortId) {
      devlog(`fetchChannelSubscribers: fetching for ${shortId}`);
      const result = await safeInvoke('channels:users', { shortId });
      
      devlog(`fetchChannelSubscribers: result: ${JSON.stringify(result)}`);
      
      const list = document.getElementById('channel-subscribers-list');
      
      if (result.error) {
        list.innerHTML = `<div class="empty"><p>Error loading subscribers</p><p class="text-gray">${result.error}</p></div>`;
        return;
      }
      
      const users = result.users || [];
      
      if (!users.length) {
        list.innerHTML = `<div class="empty"><p>No subscribers yet</p></div>`;
        return;
      }
      
      list.innerHTML = '';
      users.forEach(user => {
        const div = document.createElement('div');
        div.className = 'tile tile-centered my-1';
        const phone = user.phone || user.email || 'Unknown';
        const isCreator = phone === confirmedPhone;
        
        div.innerHTML = `
          <div class="tile-content">
            <div class="tile-title">${phone} ${isCreator ? '<span class="label label-primary ml-2">You</span>' : ''}</div>
            ${user.online ? '<span class="status-dot online"></span> Online' : '<span class="status-dot offline"></span> Offline'}
          </div>
          <div class="tile-action">
            <button class="btn btn-sm btn-error" onclick="removeSubscriber('${shortId}', '${phone}')"><i class="icon icon-cross"></i></button>
          </div>`;
        list.appendChild(div);
      });
    }
    
    async function addSubscriber() {
      const phoneInput = document.getElementById('add-subscriber-phone').value.trim();
      const countryCode = document.getElementById('add-subscriber-country').value;
      
      if (!phoneInput) {
        showToast('Phone number is required', 'error');
        return;
      }
      
      // Clean the phone input - remove any non-digits
      const cleanPhone = phoneInput.replace(/\D/g, '');
      
      // Combine country code with phone number
      const fullPhone = countryCode + cleanPhone;
      
      devlog(`addSubscriber: adding ${fullPhone} to ${currentChannelShortId}`);
      
      const result = await safeInvoke('channels:subscribe', {
        shortId: currentChannelShortId,
        phone: fullPhone
      });
      
      devlog(`addSubscriber: result: ${JSON.stringify(result)}`);
      
      if (result.ok) {
        document.getElementById('add-subscriber-phone').value = '';
        showToast('Subscriber added!');
        await fetchChannelSubscribers(currentChannelShortId);
      } else {
        showToast(`Error: ${result.error || 'Failed to add subscriber'}`, 'error');
      }
    }
    
    async function removeSubscriber(shortId, phone) {
      if (!confirm(`Remove ${phone} from this channel?`)) return;
      
      devlog(`removeSubscriber: removing ${phone} from ${shortId}`);
      
      const result = await safeInvoke('channels:unsubscribe', {
        shortId: shortId,
        phone: phone
      });
      
      devlog(`removeSubscriber: result: ${JSON.stringify(result)}`);
      
      if (result.ok) {
        showToast('Subscriber removed');
        await fetchChannelSubscribers(shortId);
      } else {
        showToast(`Error: ${result.error || 'Failed to remove subscriber'}`, 'error');
      }
    }
    
    async function sendChannelMessage() {
      const message = document.getElementById('send-message-text').value.trim();
      if (!message) {
        showToast('Message is required', 'error');
        return;
      }
      
      const channelName = document.getElementById('channel-details-title').textContent;
      
      devlog(`sendChannelMessage: sending message to channel ${currentChannelShortId}`);
      
      const result = await safeInvoke('channels:send', {
        shortId: currentChannelShortId,
        title: `Message from ${channelName}`,
        body: message
      });
      
      devlog(`sendChannelMessage: result: ${JSON.stringify(result)}`);
      
      if (result.ok) {
        document.getElementById('send-message-text').value = '';
        showToast('Message sent to all subscribers!');
      } else {
        showToast(`Error: ${result.error || 'Failed to send message'}`, 'error');
      }
    }
    
    function copyChannelId() {
      const id = document.getElementById('channel-details-id').value;
      navigator.clipboard.writeText(id).then(
        () => showToast('Channel ID copied!'),
        () => showToast('Failed to copy', 'error')
      );
    }
    
    async function fetchChannels() {
      devlog('fetchChannels: fetching channels...');
      const result = await safeInvoke('channels:list');

      devlog(`fetchChannels: channels:list result: ${JSON.stringify(result)}`);

      const list = document.getElementById('channels-list');
      list.innerHTML = '';

      if (result.error) {
        list.innerHTML = `<div class="empty"><p>Error</p><p class="text-gray">${result.error}</p></div>`;
        return;
      }

      // Accept both { channels: [...] } and bare [...]
      const channels = Array.isArray(result) ? result : (result.channels || []);

      if (!channels.length) {
        list.innerHTML = `<div class="empty"><p>No channels yet</p><p class="text-gray">Create one or join a public channel.</p></div>`;
        return;
      }

      channels.forEach(ch => {
        const div = document.createElement('div');
        div.className = 'tile my-2';
        div.style.cursor = 'pointer';
        div.innerHTML = `
          <div class="tile-content" onclick="showChannelDetails('${ch.short_id}', '${ch.name.replace(/'/g, "\\'")}')">
            <p class="tile-title h6">${ch.name}</p>
            <p class="tile-subtitle text-gray">${ch.description || `ID: ${ch.short_id}`}</p>
          </div>
          <div class="tile-action">
            <button class="btn btn-sm" onclick="event.stopPropagation(); navigator.clipboard.writeText('${ch.short_id}'); showToast('Copied ID!')"><i class="icon icon-copy"></i> Copy ID</button>
          </div>`;
        list.appendChild(div);
      });
    }

    async function createChannel() {
      devlog('createChannel: creating channel...');
      const name = document.getElementById('new-channel-name').value;
      const description = document.getElementById('new-channel-desc').value;
      const allow_public = document.getElementById('new-channel-public').checked;
      if (!name) { showToast('Channel name is required', 'error'); return; }

      devlog(`createChannel: creating channel: ${name}`);

      // FIX: use camelCase keys expected by main
      // Don't auto-subscribe creator to avoid transaction issues
      const result = await safeInvoke('channels:create', {
        name,
        description,
        allowPublic: allow_public
        // Removed creatorPhone to prevent transaction errors
      });

      devlog(`createChannel: channels:create result: ${JSON.stringify(result)}`);

      if (result.ok) {
        closeModal('create-channel-modal');
        fetchChannels();
        showToast('Channel created successfully!');
      } else {
        showToast(`Error: ${result?.error || 'No response from server'}`, 'error');
      }
    }

    async function joinChannel() {
      devlog('joinChannel: joining channel...');
      const short_id = document.getElementById('join-channel-id').value;
      if (!short_id) { showToast('Channel ID is required', 'error'); return; }

      // FIX: call an existing handler; join public channels by short ID
      const result = await safeInvoke('public:channels:join', {
        shortId: short_id,
        phone: confirmedPhone
      });

      devlog(`joinChannel: public:channels:join result: ${JSON.stringify(result)}`);

      if (result && result.ok) {
        closeModal('join-channel-modal');
        fetchChannels();
        showToast('Joined channel!');
      } else {
        showToast(`Error: ${result?.error || 'No response from server'}`, 'error');
      }
    }

    // --- App Log ---
    async function fetchLog() {
      try {
        devlog('fetchLog: reading app logs');
        const result = await receiver.invoke('app:logs:read', { maxChars: 50000 });
        const output = document.getElementById('log-output');
        if (result.ok) {
          output.textContent = result.content || '(empty log)';
          output.scrollTop = output.scrollHeight;
        } else {
          output.textContent = `Error reading log: ${result.error}`;
        }
      } catch (e) {
        devlog(`fetchLog error: ${e}`);
        document.getElementById('log-output').textContent = `Error: ${e.message}`;
      }
    }
    
    function copyLog() {
      const log = document.getElementById('log-output').textContent;
      navigator.clipboard.writeText(log).then(() => showToast('Log copied!'), () => showToast('Copy failed', 'error'));
    }

    function clearLog() {
      document.getElementById('log-output').textContent = '';
    }

    // --- Authentication ----
    async function initAuth() {
      devlog('initAuth: starting');
      const dev = await receiver.invoke('dev:get');
      devState = dev || {};
      confirmedPhone = devState.verifiedPhone;
      devlog(`initAuth: phone=${confirmedPhone ? 'yes' : 'no'}`);

      if (confirmedPhone) {
        document.getElementById('phone-login-overlay').style.display = 'none';
        document.getElementById('confirmed-phone').textContent = confirmedPhone;
        document.getElementById('dev-id').textContent = devState.devId || 'N/A';

        // Disable create channel button if no devId
        const createChannelBtn = document.querySelector("button[onclick=\"showCreateChannelModal()\"]");
        if (devState.devId) {
          createChannelBtn.disabled = false;
        } else {
          createChannelBtn.disabled = true;
        }

        document.getElementById('tabs-container').style.opacity = 1;
        document.getElementById('content-container').style.opacity = 1;
        fetchChannels();
      } else {
        document.getElementById('phone-login-overlay').style.display = 'flex';
        document.getElementById('tabs-container').style.opacity = 0.3;
        document.getElementById('content-container').style.opacity = 0.3;
      }

      document.getElementById('submit-phone').addEventListener('click', async () => {
        const phone = document.getElementById('phone-input').value.trim();
        if (!phone) { showToast('Phone number is required.', 'error'); return; }
        
        // ADMIN BYPASS: Skip Twilio verification for admin phone
        // Normalize phone number for comparison
        const normalizedPhone = phone.replace(/[\s\-\(\)\.]/g, '').replace(/^\+?1?/, '');
        devlog(`auth: checking admin bypass - input: ${phone}, normalized: ${normalizedPhone}`);
        
        if (normalizedPhone === '6505551212') {
          devlog('auth: ADMIN BYPASS ACTIVATED - skipping Twilio verification');
          showToast('Admin mode activated - Enter code: ADMIN');
          document.getElementById('verify-code-group').style.display = 'block';
          // Store the admin phone in standard format for the code check
          document.getElementById('phone-input').dataset.adminBypass = 'true';
          return;
        }
        
        devlog('auth: sending phone for verification');
        const result = await receiver.invoke('verify:start', { phone });
        if (result.ok) {
          showToast('Verification code sent.');
          document.getElementById('verify-code-group').style.display = 'block';
        } else {
          showToast(`Error: ${result.error}`, 'error');
        }
      });
      
      document.getElementById('submit-code').addEventListener('click', async () => {
        const phone = document.getElementById('phone-input').value.trim();
        const code = document.getElementById('verify-code-input').value.trim();
        if (!code) { showToast('Verification code is required.', 'error'); return; }

        // ADMIN BYPASS: Accept "ADMIN" code for admin phone
        const isAdminBypass = document.getElementById('phone-input').dataset.adminBypass === 'true';
        devlog(`auth: code submission - isAdminBypass: ${isAdminBypass}, code: ${code}`);
        
        if (isAdminBypass && code.toUpperCase() === 'ADMIN') {
          devlog('auth: ADMIN BYPASS - using admin code');
          // Call special admin verification
          const result = await receiver.invoke('verify:admin', { phone: '+16505551212' });
          if (result.ok) {
            showToast('Admin login successful!');
            devlog('auth: admin verification successful, re-initializing');
            // Clear the bypass flag
            delete document.getElementById('phone-input').dataset.adminBypass;
            initAuth();
          } else {
            showToast(`Admin login failed: ${result.error}`, 'error');
          }
          return;
        }

        devlog('auth: sending code for verification');
        const result = await receiver.invoke('verify:check', { phone, code });
        if (result.ok) {
          showToast('Verification successful!');
          devlog('auth: verification successful, re-initializing');
          initAuth();
        } else {
          showToast(`Error: ${result.error}`, 'error');
        }
      });

      document.getElementById('logout-button').addEventListener('click', async () => {
        devlog('logout: starting');
        try {
          const ok = await receiver.invoke('auth:logout');
          devlog(`logout: invoke result ok=${ok}`);
          
          // Clear all local state immediately
          confirmedPhone = null;
          devState = {};
          document.getElementById('confirmed-phone').textContent = '';
          document.getElementById('dev-id').textContent = '';
          
          // Clear any stored session data
          try {
            sessionStorage.clear();
            localStorage.removeItem('DEV_ID');
            sessionStorage.removeItem('SANDBOX_READY');
          } catch {}
          
          // Force show login screen immediately without waiting for reload
          document.getElementById('phone-login-overlay').style.display = 'flex';
          document.getElementById('tabs-container').style.opacity = 0.3;
          document.getElementById('content-container').style.opacity = 0.3;
          document.getElementById('phone-input').value = '';
          document.getElementById('verify-code-input').value = '';
          document.getElementById('verify-code-group').style.display = 'none';
          
          // Clear channels list
          document.getElementById('channels-list').innerHTML = '';
          
          showToast('Logged out successfully');
          
          // Don't call initAuth() - the user needs to login again manually
          devlog('logout: complete - showing login screen');
        } catch (e) {
          devlog(`logout: invoke error: ${e}`);
          showToast(`Logout failed: ${e.message}`, 'error');
        }
      });
    }

    // --- Channel Tabs ---
    function showChannelTab(tabName) {
      document.querySelectorAll('.channel-tab-content').forEach(t => t.style.display = 'none');
      document.querySelectorAll('#channel-details-modal .tab-item').forEach(t => t.classList.remove('active'));
      
      document.getElementById(`channel-${tabName}-tab`).style.display = 'block';
      document.querySelector(`#channel-details-modal .tab-item a[onclick*="'${tabName}'"]`).parentElement.classList.add('active');
      
      if (tabName === 'subscribers') {
        fetchChannelSubscribers(currentChannelShortId);
      } else if (tabName === 'scripts') {
        fetchChannelScripts(currentChannelShortId);
      }
    }
    
    // --- Scripts ---
    let scriptVariableCount = 0;
    
    function showCreateScriptForm() {
      document.getElementById('create-script-form').style.display = 'block';
      document.getElementById('script-variables-list').innerHTML = '';
      scriptVariableCount = 0;
    }
    
    function hideCreateScriptForm() {
      document.getElementById('create-script-form').style.display = 'none';
    }
    
    function updateTriggerFields() {
      const triggerType = document.getElementById('script-trigger-type').value;
      document.getElementById('schedule-cron-group').style.display = 
        triggerType === 'schedule' ? 'block' : 'none';
    }
    
    function addScriptVariable() {
      scriptVariableCount++;
      const div = document.createElement('div');
      div.className = 'form-group';
      div.innerHTML = `
        <div style="border: 1px solid #ddd; padding: 10px; margin-bottom: 10px;">
          <input class="form-input" type="text" id="var-name-${scriptVariableCount}" placeholder="Variable name (e.g., zip_code)">
          <input class="form-input mt-1" type="text" id="var-display-${scriptVariableCount}" placeholder="Display name (e.g., ZIP Code)">
          <textarea class="form-input mt-1" id="var-desc-${scriptVariableCount}" rows="2" placeholder="Description"></textarea>
          <select class="form-select mt-1" id="var-type-${scriptVariableCount}">
            <option value="string">Text</option>
            <option value="number">Number</option>
            <option value="boolean">Yes/No</option>
          </select>
          <button class="btn btn-sm btn-error mt-1" onclick="this.parentElement.parentElement.remove()">Remove</button>
        </div>
      `;
      document.getElementById('script-variables-list').appendChild(div);
    }
    
    async function createScript() {
      const prompt = document.getElementById('script-prompt').value.trim();
      
      if (!prompt) {
        showToast('Please describe what the script should do', 'error');
        return;
      }
      
      // Extract a name from the first line or first 50 chars of the prompt
      const name = prompt.split('\n')[0].substring(0, 50).replace(/[^a-zA-Z0-9 ]/g, '') || 'Untitled Script';
      
      // Collect variables
      const variables = [];
      const varElements = document.getElementById('script-variables-list').children;
      for (let el of varElements) {
        const id = el.querySelector('input').id.match(/\d+/)[0];
        const varName = document.getElementById(`var-name-${id}`).value.trim();
        const varDisplay = document.getElementById(`var-display-${id}`).value.trim();
        const varDesc = document.getElementById(`var-desc-${id}`).value.trim();
        const varType = document.getElementById(`var-type-${id}`).value;
        
        if (varName) {
          variables.push({
            name: varName,
            display_name: varDisplay || varName,
            description: varDesc,
            type: varType
          });
        }
      }
      
      devlog(`createScript: creating script for channel ${currentChannelShortId}`);
      
      const result = await safeInvoke('scripts:create', {
        shortId: currentChannelShortId,
        name,
        prompt,
        variables
      });
      
      devlog(`createScript: result: ${JSON.stringify(result)}`);
      
      if (result.ok) {
        showToast('Script created successfully!');
        hideCreateScriptForm();
        fetchChannelScripts(currentChannelShortId);
        
        if (result.script && result.script.webhook_url) {
          showToast(`Webhook URL: ${result.script.webhook_url}`, 'success');
        }
      } else {
        showToast(`Error: ${result.error || 'Failed to create script'}`, 'error');
      }
    }
    
    async function fetchChannelScripts(shortId) {
      devlog(`fetchChannelScripts: fetching for ${shortId}`);
      
      const result = await safeInvoke('scripts:list', { shortId });
      
      devlog(`fetchChannelScripts: result: ${JSON.stringify(result)}`);
      
      const list = document.getElementById('channel-scripts-list');
      
      if (result.error) {
        list.innerHTML = `<div class="empty"><p>Error loading scripts</p><p class="text-gray">${result.error}</p></div>`;
        return;
      }
      
      const scripts = result.scripts || [];
      
      if (!scripts.length) {
        list.innerHTML = `<div class="empty">No scripts yet</div>`;
        return;
      }
      
      list.innerHTML = '';
      scripts.forEach(script => {
        const div = document.createElement('div');
        div.className = 'tile tile-centered my-1';
        
        let triggerInfo = '';
        if (script.trigger_type === 'webhook') {
          triggerInfo = '<span class="label">Webhook</span>';
        } else if (script.trigger_type === 'schedule') {
          triggerInfo = `<span class="label">Schedule: ${script.schedule_cron}</span>`;
        } else {
          triggerInfo = '<span class="label">Manual</span>';
        }
        
        div.innerHTML = `
          <div class="tile-content">
            <div class="tile-title">${script.name}</div>
            <div class="tile-subtitle">
              ${triggerInfo}
              ${script.is_active ? '<span class="label label-success">Active</span>' : '<span class="label label-error">Inactive</span>'}
              ${script.execution_count ? `<span class="text-gray">Runs: ${script.execution_count}</span>` : ''}
            </div>
          </div>
          <div class="tile-action">
            <button class="btn btn-sm" onclick="testScript('${script.id}')">Test</button>
            <button class="btn btn-sm btn-error" onclick="deleteScript('${script.id}')">Delete</button>
          </div>`;
        list.appendChild(div);
      });
    }
    
    async function testScript(scriptId) {
      devlog(`testScript: testing script ${scriptId}`);
      
      const result = await safeInvoke('scripts:execute', { scriptId });
      
      devlog(`testScript: result: ${JSON.stringify(result)}`);
      
      if (result.ok) {
        showToast(`Script executed! Sent ${result.notificationsSent || 0} notifications`);
      } else {
        showToast(`Error: ${result.error || 'Failed to execute script'}`, 'error');
      }
    }
    
    async function deleteScript(scriptId) {
      if (!confirm('Delete this script?')) return;
      
      devlog(`deleteScript: deleting script ${scriptId}`);
      
      const result = await safeInvoke('scripts:delete', { scriptId });
      
      devlog(`deleteScript: result: ${JSON.stringify(result)}`);
      
      if (result.ok) {
        showToast('Script deleted');
        fetchChannelScripts(currentChannelShortId);
      } else {
        showToast(`Error: ${result.error || 'Failed to delete script'}`, 'error');
      }
    }

    // --- Init ---
    document.addEventListener('DOMContentLoaded', () => {
      devlog('DOMContentLoaded: starting init');
      initAuth();
      showTab('channels'); // default tab
    });
  </script>
</body>
</html>
