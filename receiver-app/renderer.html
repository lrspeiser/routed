<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Routed Receiver</title>
  <style>
    body { font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial; margin: 16px; }
    header { display:flex; align-items:center; gap:8px; }
    header img { width: 18px; height: 18px; }
    input, button { font-size: 14px; padding: 8px; margin: 4px 0; width: 100%; }
    #log { white-space: pre-wrap; height: 240px; overflow: auto; background: #111; color: #0f0; padding: 8px; border-radius: 6px; }
    .row { margin-top: 8px; }
  </style>
</head>
<body>
  <header>
    <img src="arrow-icon-routed.png" alt="Routed" />
    <h2 style="margin:0">Routed</h2>
  </header>
  <div class="row" style="opacity:.7">Before connecting, we check your server health.</div>
  <div class="row" id="health">Checking serverâ€¦</div>
  <div class="row">
    <label>Your Phone</label>
    <input id="phone" placeholder="+14155551234" />
  </div>
  <button id="connectBtn" disabled>Connect</button>

  <div class="row" style="margin-top:16px">
    <div style="display:flex; gap:8px; border-bottom:1px solid #ddd; padding-bottom:6px">
      <button id="tabClient" style="flex:1">Client</button>
      <button id="tabDev" style="flex:1">Developer</button>
    </div>
  </div>

  <div id="clientTab" class="row">
    <h3>Notifications</h3>
    <div id="status"></div>
    <div id="notifList" style="margin-top:8px; display:flex; flex-direction:column; gap:8px"></div>
  </div>

  <div id="devTab" class="row" style="display:none">
    <h3>Developer Console</h3>
    <div id="devInfo" style="font-family:monospace; background:#f6f6f6; padding:8px; border-radius:6px"></div>
    <div style="display:flex; gap:8px; margin-top:8px">
      <button id="provisionBtn">Provision Sandbox</button>
      <button id="refreshChannelsBtn">Refresh Channels</button>
    </div>
    <div class="row">
      <label>New Channel Name</label>
      <input id="newChannelName" placeholder="e.g., QA Team" />
      <button id="createChannelBtn">Create Channel</button>
    </div>
    <div class="row">
      <label>Add User Phone to Channel (by Short ID)</label>
      <input id="addUserShortId" placeholder="channel short id" />
      <input id="addUserPhone" placeholder="+14155551234" />
      <input id="addUserTopic" placeholder="topic (default runs.finished)" />
      <button id="addUserBtn">Add User</button>
    </div>
    <div class="row">
      <label>Send Message</label>
      <input id="sendTopic" placeholder="topic (default runs.finished)" />
      <input id="sendTitle" placeholder="Title" />
      <input id="sendBody" placeholder="Body" />
      <textarea id="sendPayload" placeholder='Payload JSON (optional)'></textarea>
      <button id="sendBtn">Send</button>
    </div>
    <div class="row">
      <h4>Channels</h4>
      <div id="channels"></div>
    </div>
  </div>

  <script>
    const logEl = document.getElementById('log');
    function log(msg) { logEl.textContent += '\n' + new Date().toISOString() + ' ' + msg; logEl.scrollTop = logEl.scrollHeight; }

    // Default to your playground origin (has /api/* helpers)
    const RESOLVE_BASE = 'https://routed-gbiz.onrender.com';
    const healthEl = document.getElementById('health');
    const connectBtn = document.getElementById('connectBtn');

    async function checkHealth() {
      // First try playground proxy /api/healthz
      try {
        let url = new URL('/api/healthz', RESOLVE_BASE).toString();
        let res = await fetch(url, { cache: 'no-store' });
        let json = null;
        const ct = (res.headers.get('content-type') || '').toLowerCase();
        if (ct.includes('application/json')) {
          try { json = await res.json(); } catch {}
        }
        if (res.ok && json && json.ok) {
          if (json.hub_ok) {
            healthEl.innerHTML = `Server: <span style="color:#22c55e">OK</span> (${json.hub_url || 'not set'})`;
            connectBtn.disabled = false;
            return;
          } else {
            healthEl.innerHTML = `Server: <span style="color:#ef4444">UNREACHABLE</span> ${json.hub_error ? '(' + json.hub_error + ')' : ''}. Check HUB_URL on playground/server.`;
            connectBtn.disabled = false; // still allow trying to connect
            return;
          }
        }
        // Fallback: try hub /healthz
        url = new URL('/healthz', RESOLVE_BASE).toString();
        res = await fetch(url, { cache: 'no-store' });
        if (res.ok) {
          healthEl.innerHTML = `Server (direct): <span style="color:#22c55e">OK</span>`;
          connectBtn.disabled = false;
          return;
        }
        healthEl.textContent = `Health check failed. Status ${res.status}`;
        connectBtn.disabled = false; // allow manual connect attempt anyway
      } catch (e) {
        healthEl.textContent = `Health check error: ${e && e.message ? e.message : e}`;
        connectBtn.disabled = false; // allow manual connect attempt anyway
      }
    }
    let ws;
    const notifList = document.getElementById('notifList');
    function addNotificationCard(data) {
      const card = document.createElement('div');
      card.style.border = '1px solid #ddd';
      card.style.borderRadius = '8px';
      card.style.padding = '8px';
      card.innerHTML = `<div style="font-weight:600">${(data.title||'').replace(/</g,'&lt;')}</div><div>${(data.body||'').replace(/</g,'&lt;')}</div>`;
      notifList.prepend(card);
    }
    function makeWsUrl(base, userId, path) {
      const url = new URL(base);
      const wsProto = url.protocol === 'https:' ? 'wss' : 'ws';
      return `${wsProto}://${url.host}${path}?user_id=${encodeURIComponent(userId)}`;
    }

    async function connectWithPhone(phone) {
      try {
        const res = await fetch(new URL('/api/resolve-email', RESOLVE_BASE).toString(), {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email: phone })
        });
        let desc = null;
        try { desc = await res.json(); } catch {}
        if (!res.ok || !desc || !desc.base_url || !desc.user_id) {
          log('Resolve failed' + (res ? ` (status=${res.status})` : '') + (desc ? ` ${JSON.stringify(desc)}` : ''));
          return;
        }
        log(`Resolved: base_url=${desc.base_url} user_id=${desc.user_id}`);
        const base = desc.base_url;
        const urlV1 = makeWsUrl(base, desc.user_id, '/v1/socket');
        const urlAlt = makeWsUrl(base, desc.user_id, '/socket');

        async function tryConnect(urls) {
          if (!urls.length) { log('All WS endpoints failed'); return; }
          const next = urls[0];
          log(`Connecting to ${next}`);
          return new Promise((resolve) => {
            let opened = false;
            const candidate = new WebSocket(next);
            candidate.onopen = () => {
              opened = true;
              ws = candidate;
              log('WS open');
              document.getElementById('status').textContent = 'Connected';
              resolve(null);
            };
            candidate.onmessage = (ev) => {
              log(ev.data);
              try {
                const data = JSON.parse(ev.data);
                if (data && data.type === 'hello') {
                  // handshake ok
                } else if (data && data.title) {
                  window.receiver.showNotification(data);
                  addNotificationCard(data);
                }
              } catch {}
            };
            candidate.onclose = (e) => {
              if (!opened) {
                log(`WS close before open (${next}) code=${e.code}`);
                tryConnect(urls.slice(1)).then(resolve);
              } else {
                log(`WS closed code=${e.code} reason=${e.reason}`);
                document.getElementById('status').textContent = 'Disconnected';
              }
            };
            candidate.onerror = (e) => {
              try { log(`WS error on ${next}: ` + (e.message || JSON.stringify(e))); } catch { log('WS error'); }
            };
          });
        }

        await tryConnect([urlAlt, urlV1]);
      } catch (e) {
        log('Connect failed: ' + e);
      }
    }

    document.getElementById('connectBtn').addEventListener('click', async () => {
      const phone = document.getElementById('phone').value.trim();
      if (!phone) { alert('Enter your phone'); return; }
      try { localStorage.setItem('ROUTED_PHONE', phone); } catch {}
      await connectWithPhone(phone);
    });

    // Tabs
    const clientTab = document.getElementById('clientTab');
    const devTab = document.getElementById('devTab');
    function showTab(which) {
      clientTab.style.display = which === 'client' ? '' : 'none';
      devTab.style.display = which === 'dev' ? '' : 'none';
    }
    document.getElementById('tabClient').addEventListener('click', () => showTab('client'));
    document.getElementById('tabDev').addEventListener('click', () => showTab('dev'));

    // Dev console handlers
    const devInfoEl = document.getElementById('devInfo');
    async function refreshDevInfo() {
      const d = await window.receiver.devGet();
      devInfoEl.textContent = d ? JSON.stringify(d, null, 2) : 'Not provisioned';
    }
    document.getElementById('provisionBtn').addEventListener('click', async () => {
      await window.receiver.devProvision();
      await refreshDevInfo();
    });
    document.getElementById('refreshChannelsBtn').addEventListener('click', async () => {
      const d = await window.receiver.devGet();
      if (!d || !d.tenantId) { alert('Provision first'); return; }
      const ch = await window.receiver.adminChannelsList(d.tenantId);
      document.getElementById('channels').textContent = JSON.stringify(ch, null, 2);
    });
    document.getElementById('createChannelBtn').addEventListener('click', async () => {
      const d = await window.receiver.devGet();
      if (!d || !d.tenantId) { alert('Provision first'); return; }
      const name = (document.getElementById('newChannelName').value || '').trim();
      if (!name) { alert('Enter a channel name'); return; }
      await window.receiver.adminChannelsCreate({ tenantId: d.tenantId, name, topic: 'runs.finished' });
      document.getElementById('newChannelName').value = '';
      const ch = await window.receiver.adminChannelsList(d.tenantId);
      document.getElementById('channels').textContent = JSON.stringify(ch, null, 2);
    });
    document.getElementById('addUserBtn').addEventListener('click', async () => {
      const d = await window.receiver.devGet();
      if (!d || !d.tenantId) { alert('Provision first'); return; }
      const shortId = (document.getElementById('addUserShortId').value || '').trim();
      const phone = (document.getElementById('addUserPhone').value || '').trim();
      const topic = (document.getElementById('addUserTopic').value || '').trim() || 'runs.finished';
      if (!shortId || !phone) { alert('Enter short id and phone'); return; }
      // Ensure user exists and subscribed (by topic). Channel association is topic-based.
      await window.receiver.adminUsersEnsure({ tenantId: d.tenantId, phone, topic });
      const users = await window.receiver.adminChannelsUsers(shortId);
      alert(`Channel users now: ${users.length}`);
      document.getElementById('addUserShortId').value='';
      document.getElementById('addUserPhone').value='';
      document.getElementById('addUserTopic').value='';
    });
    document.getElementById('sendBtn').addEventListener('click', async () => {
      const topic = (document.getElementById('sendTopic').value || '').trim() || 'runs.finished';
      const title = (document.getElementById('sendTitle').value || '').trim() || 'Hello';
      const body = (document.getElementById('sendBody').value || '').trim() || 'World';
      let payload = null;
      try { const raw = document.getElementById('sendPayload').value; payload = raw ? JSON.parse(raw) : null; } catch { payload = null; }
      await window.receiver.devSendMessage({ topic, title, body, payload });
    });

    (async () => {
      await checkHealth();
      try {
        const saved = localStorage.getItem('ROUTED_PHONE');
        if (saved && !connectBtn.disabled) { document.getElementById('phone').value = saved; connectWithPhone(saved); }
      } catch {}
      await refreshDevInfo();
    })();
  </script>
</body>
</html>
